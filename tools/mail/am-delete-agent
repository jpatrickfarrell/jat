#!/usr/bin/env bash
#
# am-delete-agent - Delete an agent from Agent Mail
#
# Usage: am-delete-agent AGENT_NAME [--force]
#   AGENT_NAME: Name of agent to delete (globally unique)
#   --force: Skip confirmation prompt
#
# Safety:
# - Checks for active reservations (warns if found)
# - Checks for messages (warns if found)
# - Requires confirmation unless --force
#
# Note: Agents are globally unique - no project specification needed
#
# Exit codes: 0=success, 1=error, 2=user cancelled

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DB_PATH="${AGENT_MAIL_DB:-$HOME/.agent-mail.db}"

# Show help
if [[ $# -eq 0 ]] || [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cat <<EOF
am-delete-agent - Delete an agent from Agent Mail

Usage: am-delete-agent AGENT_NAME [--force]

Arguments:
  AGENT_NAME        Name of agent to delete (globally unique)
  --force           Skip confirmation prompt

Safety checks:
  - Warns if agent has active reservations
  - Warns if agent has sent messages
  - Requires confirmation (unless --force)

Examples:
  am-delete-agent OldAgent
  am-delete-agent OldAgent --force

Exit codes:
  0 = Agent deleted successfully
  1 = Error (agent not found, database error)
  2 = User cancelled

Note: Deleting an agent does NOT delete:
  - Messages sent by the agent (preserved for audit trail)
  - Task assignments in Beads (preserved)
  - Reservations are released automatically

Note: Agents are globally unique across all projects.
  No project specification needed.

EOF
    exit 0
fi

# Parse arguments
AGENT_NAME="${1:-}"
FORCE=false

shift || true
while [[ $# -gt 0 ]]; do
    case "$1" in
        --force)
            FORCE=true
            shift
            ;;
        *)
            shift
            ;;
    esac
done

if [[ -z "$AGENT_NAME" ]]; then
    echo "Error: AGENT_NAME required" >&2
    echo "Usage: am-delete-agent AGENT_NAME [--force]" >&2
    exit 1
fi

# Check database exists
if [[ ! -f "$DB_PATH" ]]; then
    echo "Error: Agent Mail database not found at $DB_PATH" >&2
    echo "Run 'am-register' first to initialize" >&2
    exit 1
fi

# Find agent by name (globally unique - should be exactly one)
AGENT_ID=$(sqlite3 "$DB_PATH" \
    "SELECT id FROM agents WHERE name = '$AGENT_NAME' LIMIT 1;" 2>/dev/null || echo "")

if [[ -z "$AGENT_ID" ]]; then
    echo "Error: Agent '$AGENT_NAME' not found" >&2
    exit 1
fi

# Get project info for display
PROJECT_ID=$(sqlite3 "$DB_PATH" \
    "SELECT project_id FROM agents WHERE id = $AGENT_ID LIMIT 1;")
PROJECT_PATH=$(sqlite3 "$DB_PATH" \
    "SELECT human_key FROM projects WHERE id = $PROJECT_ID LIMIT 1;" 2>/dev/null || echo "unknown")

# Safety checks
echo "Checking agent dependencies..." >&2

# Check for active reservations
ACTIVE_RESERVATIONS=$(sqlite3 "$DB_PATH" \
    "SELECT COUNT(*) FROM file_reservations
     WHERE agent_id = $AGENT_ID
     AND released_ts IS NULL
     AND datetime(expires_ts) > datetime('now');" || echo "0")

if [[ "$ACTIVE_RESERVATIONS" -gt 0 ]]; then
    echo "⚠️  Warning: Agent has $ACTIVE_RESERVATIONS active reservation(s)" >&2
    echo "   These will be released on deletion" >&2
fi

# Check for messages
MESSAGE_COUNT=$(sqlite3 "$DB_PATH" \
    "SELECT COUNT(*) FROM messages WHERE sender_id = $AGENT_ID;" || echo "0")

if [[ "$MESSAGE_COUNT" -gt 0 ]]; then
    echo "⚠️  Warning: Agent has sent $MESSAGE_COUNT message(s)" >&2
    echo "   Messages will be preserved but sender will be orphaned" >&2
fi

# Confirmation prompt (unless --force)
if [[ "$FORCE" != true ]]; then
    echo ""
    echo "Delete agent '$AGENT_NAME'?"
    echo "  Project: $PROJECT_PATH"
    echo "  Reservations: $ACTIVE_RESERVATIONS active"
    echo "  Messages: $MESSAGE_COUNT sent"
    echo ""
    read -p "Confirm deletion? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Deletion cancelled"
        exit 2
    fi
fi

# Delete agent (messages are preserved, reservations are released)
sqlite3 "$DB_PATH" <<SQL
BEGIN TRANSACTION;

-- Release all active reservations for this agent
UPDATE file_reservations
SET released_ts = datetime('now')
WHERE agent_id = $AGENT_ID
AND released_ts IS NULL;

-- Delete agent record
-- Note: messages are preserved (sender_id becomes orphaned but queryable)
DELETE FROM agents WHERE id = $AGENT_ID;

COMMIT;
SQL

if [[ $? -eq 0 ]]; then
    echo "✓ Agent '$AGENT_NAME' deleted successfully"
    [[ "$ACTIVE_RESERVATIONS" -gt 0 ]] && echo "  Released $ACTIVE_RESERVATIONS reservation(s)"
    [[ "$MESSAGE_COUNT" -gt 0 ]] && echo "  Preserved $MESSAGE_COUNT message(s)"
    exit 0
else
    echo "Error: Failed to delete agent" >&2
    exit 1
fi
