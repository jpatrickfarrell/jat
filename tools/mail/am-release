#!/usr/bin/env bash
# Release file reservations
# Usage: am-release "glob/pattern" --agent AgentName
#        am-release --id 123
#        am-release --all --agent AgentName

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/am-lib.sh"

# Parse arguments
PATH_PATTERN=""
AGENT_NAME=""
RESERVATION_ID=""
RELEASE_ALL=false
PROJECT="$PROJECT_KEY"
JSON_OUTPUT=false

show_help() {
    cat <<EOF
Usage: am-release [pattern|options]

Release file reservations manually before expiry.

Release by pattern:
  am-release "path/pattern" --agent AGENT

Release by ID:
  am-release --id ID

Release all for agent:
  am-release --all --agent AGENT

Options:
  --agent AGENT       Agent name (required unless using --id)
  --id ID             Release specific reservation by ID
  --all               Release all active reservations for agent
  --project PATH      Project path (default: current directory)
  --json              Output as JSON
  --help, -h          Show this help

Examples:
  am-release "src/**/*.ts" --agent Alice
  am-release --id 5
  am-release --all --agent Bob
  am-release "lib/**" --agent Carol --json

Database: $AGENT_MAIL_DB
EOF
}

# First positional arg is path pattern (if not a flag)
if [[ $# -ge 1 ]] && [[ ! "$1" =~ ^-- ]]; then
    PATH_PATTERN="$1"
    shift
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        --agent)
            AGENT_NAME="$2"
            shift 2
            ;;
        --id)
            RESERVATION_ID="$2"
            shift 2
            ;;
        --all)
            RELEASE_ALL=true
            shift
            ;;
        --project)
            PROJECT="$2"
            shift 2
            ;;
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            am_error "Unknown option: $1"
            ;;
    esac
done

# Get or create project
PROJECT_ID=$(am_get_project "$AGENT_MAIL_DB" "$PROJECT")

# Validate arguments based on mode
if [[ -n "$RESERVATION_ID" ]]; then
    # Release by ID mode
    if [[ -n "$AGENT_NAME" ]] || [[ -n "$PATH_PATTERN" ]] || [[ "$RELEASE_ALL" == "true" ]]; then
        am_error "When using --id, do not specify --agent, pattern, or --all"
    fi
elif [[ "$RELEASE_ALL" == "true" ]]; then
    # Release all mode
    if [[ -z "$AGENT_NAME" ]]; then
        am_error "--agent is required with --all"
    fi
    if [[ -n "$PATH_PATTERN" ]]; then
        am_error "Do not specify pattern with --all"
    fi
elif [[ -n "$PATH_PATTERN" ]]; then
    # Release by pattern mode
    if [[ -z "$AGENT_NAME" ]]; then
        am_error "--agent is required when releasing by pattern"
    fi
else
    am_error "Must specify either pattern, --id, or --all"
fi

# Release by ID
if [[ -n "$RESERVATION_ID" ]]; then
    # Verify reservation exists and is active
    EXISTS=$(sqlite3 "$AGENT_MAIL_DB" "SELECT COUNT(*) FROM file_reservations WHERE id = $RESERVATION_ID AND project_id = $PROJECT_ID AND released_ts IS NULL;")
    if [[ "$EXISTS" == "0" ]]; then
        am_error "Reservation ID $RESERVATION_ID not found or already released"
    fi

    # Release it
    sqlite3 "$AGENT_MAIL_DB" "UPDATE file_reservations SET released_ts = datetime('now') WHERE id = $RESERVATION_ID;"

    am_success "Released reservation ID: $RESERVATION_ID"
    exit 0
fi

# Validate agent exists
AGENT_ID=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM agents WHERE project_id = $PROJECT_ID AND name = '$AGENT_NAME';")
if [[ -z "$AGENT_ID" ]]; then
    am_error "Agent '$AGENT_NAME' not found. Run: am-register --name $AGENT_NAME"
fi

# Update agent's last_active
am_touch_agent "$AGENT_MAIL_DB" "$AGENT_ID"

# Release all for agent
if [[ "$RELEASE_ALL" == "true" ]]; then
    # Count active reservations
    COUNT=$(sqlite3 "$AGENT_MAIL_DB" "SELECT COUNT(*) FROM file_reservations WHERE project_id = $PROJECT_ID AND agent_id = $AGENT_ID AND released_ts IS NULL AND datetime(expires_ts) > datetime('now');")

    if [[ "$COUNT" == "0" ]]; then
        echo "No active reservations to release for $AGENT_NAME"
        exit 0
    fi

    # Release all
    sqlite3 "$AGENT_MAIL_DB" "UPDATE file_reservations SET released_ts = datetime('now') WHERE project_id = $PROJECT_ID AND agent_id = $AGENT_ID AND released_ts IS NULL;"

    am_success "Released $COUNT reservation(s) for $AGENT_NAME"
    exit 0
fi

# Release by pattern
PATTERN_ESC="${PATH_PATTERN//\'/\'\'}"

# Find matching active reservations
MATCHES=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM file_reservations WHERE project_id = $PROJECT_ID AND agent_id = $AGENT_ID AND path_pattern = '$PATTERN_ESC' AND released_ts IS NULL AND datetime(expires_ts) > datetime('now');")

if [[ -z "$MATCHES" ]]; then
    am_error "No active reservation found for pattern '$PATH_PATTERN' by agent '$AGENT_NAME'"
fi

# Count matches
COUNT=$(echo "$MATCHES" | wc -l)

# Release all matching reservations
sqlite3 "$AGENT_MAIL_DB" "UPDATE file_reservations SET released_ts = datetime('now') WHERE project_id = $PROJECT_ID AND agent_id = $AGENT_ID AND path_pattern = '$PATTERN_ESC' AND released_ts IS NULL;"

if [[ "$JSON_OUTPUT" == "true" ]]; then
    echo "{\"released\": $COUNT, \"pattern\": \"$PATH_PATTERN\", \"agent\": \"$AGENT_NAME\"}" | am_format_json
else
    am_success "Released $COUNT reservation(s) for pattern: $PATH_PATTERN"
fi
