#!/bin/bash

# JAT CLI - Jomarchy Agent Tools
# Launch complete dev environments with Hyprland colored borders

set -e

# Config location
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/jat"
CONFIG_FILE="$CONFIG_DIR/projects.json"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Default terminal (can be overridden in config)
TERMINAL="${JAT_TERMINAL:-alacritty}"

#------------------------------------------------------------------------------
# Config Management
#------------------------------------------------------------------------------

ensure_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        # Create default config
        cat > "$CONFIG_FILE" << 'EOF'
{
  "projects": {},
  "defaults": {
    "terminal": "alacritty",
    "editor": "code",
    "tools_path": "~/.local/bin",
    "claude_flags": "--dangerously-skip-permissions"
  }
}
EOF
        echo -e "${GREEN}Created config: $CONFIG_FILE${NC}"
    fi
}

get_project_config() {
    local project="$1"
    jq -r ".projects[\"$project\"] // empty" "$CONFIG_FILE"
}

list_projects() {
    jq -r '.projects | keys[]' "$CONFIG_FILE" 2>/dev/null
}

#------------------------------------------------------------------------------
# Hyprland Window Coloring
#------------------------------------------------------------------------------

apply_border_color() {
    local title_prefix="$1"
    local active_color="$2"
    local inactive_color="$3"

    if ! command -v hyprctl &>/dev/null; then
        return 0  # Skip if not on Hyprland
    fi

    hyprctl clients -j 2>/dev/null | jq -r ".[] | select(.title | startswith(\"$title_prefix\")) | .address" | while read -r addr; do
        hyprctl dispatch setprop "address:$addr" activebordercolor "$active_color" &>/dev/null || true
        hyprctl dispatch setprop "address:$addr" inactivebordercolor "$inactive_color" &>/dev/null || true
    done
}

apply_all_colors() {
    local projects
    projects=$(list_projects)

    for project in $projects; do
        local config
        config=$(get_project_config "$project")
        local name active_color inactive_color
        name=$(echo "$config" | jq -r '.name')
        active_color=$(echo "$config" | jq -r '.active_color // empty')
        inactive_color=$(echo "$config" | jq -r '.inactive_color // empty')

        if [[ -n "$active_color" ]]; then
            apply_border_color "$name:" "$active_color" "$inactive_color"
        fi
    done
    echo -e "${GREEN}Applied colors to all project windows${NC}"
}

#------------------------------------------------------------------------------
# Launch Functions
#------------------------------------------------------------------------------

launch_code() {
    local path="$1"
    local name="$2"

    echo -e "${DIM}  â†’ VS Code${NC}"
    code --new-window "$path" &
}

launch_claude() {
    local path="$1"
    local name="$2"
    local db_url="$3"
    local tools_path="$4"
    local count="${5:-1}"
    local skip_agent="${6:-false}"

    # Build environment
    local env_vars="PATH=$PATH:$tools_path:$path/.claude/tools"
    env_vars="$env_vars AGENT_MAIL_URL=http://localhost:8765"
    [[ -n "$db_url" ]] && env_vars="$env_vars DATABASE_URL=$db_url"

    # Get claude flags from config
    local claude_flags
    claude_flags=$(jq -r '.defaults.claude_flags // "--dangerously-skip-permissions"' "$CONFIG_FILE")

    # Add /agent:start prompt unless --no-agent flag was used
    if [[ "$skip_agent" != "true" ]]; then
        claude_flags="$claude_flags -p '/agent:start'"
    fi

    # Launch N Claude sessions with staggered timing
    for ((i=1; i<=count; i++)); do
        local window_title
        if [[ $count -eq 1 ]]; then
            window_title="$name: Claude"
            echo -e "${DIM}  â†’ Claude Code${NC}"
        else
            window_title="$name: Claude #$i"
            echo -e "${DIM}  â†’ Claude Code #$i${NC}"
        fi

        $TERMINAL -T "$window_title" -e bash -c "cd '$path' && $env_vars claude $claude_flags" &

        # Stagger launches by 0.5s to avoid race conditions
        if [[ $i -lt $count ]]; then
            sleep 0.5
        fi
    done
}

launch_npm() {
    local path="$1"
    local name="$2"
    local port="$3"

    if [[ -z "$port" ]]; then
        echo -e "${YELLOW}  âŠ˜ No dev server port configured${NC}"
        return 0
    fi

    echo -e "${DIM}  â†’ Dev Server :$port${NC}"
    $TERMINAL -T "$name: Dev Server :$port" -e bash -c "cd '$path' && npm run dev -- --port $port; exec bash" &
}

launch_browser() {
    local port="$1"
    local name="$2"

    if [[ -z "$port" ]]; then
        echo -e "${YELLOW}  âŠ˜ No port configured for browser${NC}"
        return 0
    fi

    echo -e "${DIM}  â†’ Browser http://localhost:$port${NC}"

    # Wait for server to start
    (
        sleep 2
        if command -v xdg-open &>/dev/null; then
            xdg-open "http://localhost:$port" &>/dev/null
        elif command -v open &>/dev/null; then
            open "http://localhost:$port"
        fi
    ) &
}

launch_project() {
    local project="$1"
    shift

    # Parse options
    local do_all=true
    local do_code=false
    local do_claude=false
    local do_npm=false
    local do_browser=false
    local session_count=1
    local skip_agent=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --code|-c)     do_all=false; do_code=true ;;
            --claude|-l)   do_all=false; do_claude=true ;;
            --npm|-n)      do_all=false; do_npm=true ;;
            --browser|-b)  do_all=false; do_browser=true ;;
            --all|-a)      do_all=true ;;
            --no-agent)    skip_agent=true ;;
            [0-9]*)        session_count="$1" ;;
            *) echo -e "${RED}Unknown option: $1${NC}"; return 1 ;;
        esac
        shift
    done

    # Get project config
    local config
    config=$(get_project_config "$project")

    if [[ -z "$config" ]]; then
        echo -e "${RED}Unknown project: $project${NC}"
        echo ""
        echo "Available projects:"
        list_projects | while read -r p; do
            echo "  â€¢ $p"
        done
        echo ""
        echo "Add a project with: jat init"
        return 1
    fi

    # Parse config
    local name path port db_url active_color inactive_color tools_path
    name=$(echo "$config" | jq -r '.name')
    path=$(echo "$config" | jq -r '.path' | sed "s|^~|$HOME|")
    port=$(echo "$config" | jq -r '.port // empty')
    db_url=$(echo "$config" | jq -r '.database_url // empty')
    active_color=$(echo "$config" | jq -r '.active_color // empty')
    inactive_color=$(echo "$config" | jq -r '.inactive_color // empty')
    tools_path=$(jq -r '.defaults.tools_path // "~/.local/bin"' "$CONFIG_FILE" | sed "s|^~|$HOME|")

    # Verify path exists
    if [[ ! -d "$path" ]]; then
        echo -e "${RED}Project path does not exist: $path${NC}"
        return 1
    fi

    echo ""
    echo -e "${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}â•‘  ${CYAN}ðŸš€ Launching: ${name}${NC}${BOLD}                                        â•‘${NC}"
    echo -e "${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "  ${DIM}Path:${NC} $path"
    [[ -n "$port" ]] && echo -e "  ${DIM}Port:${NC} $port"
    [[ -n "$active_color" ]] && echo -e "  ${DIM}Color:${NC} $active_color"
    [[ $session_count -gt 1 ]] && echo -e "  ${DIM}Sessions:${NC} $session_count"
    echo ""

    # Launch components
    if $do_all; then
        launch_code "$path" "$name"
        sleep 0.3
        launch_claude "$path" "$name" "$db_url" "$tools_path" "$session_count" "$skip_agent"
        sleep 0.3
        launch_npm "$path" "$name" "$port"
        launch_browser "$port" "$name"
    else
        $do_code && launch_code "$path" "$name"
        $do_claude && launch_claude "$path" "$name" "$db_url" "$tools_path" "$session_count" "$skip_agent"
        $do_npm && launch_npm "$path" "$name" "$port"
        $do_browser && launch_browser "$port" "$name"
    fi

    # Apply Hyprland colors
    if [[ -n "$active_color" ]]; then
        (sleep 1.5 && apply_border_color "$name:" "$active_color" "$inactive_color") &
    fi

    echo ""
    echo -e "${GREEN}âœ“ Environment launched${NC}"
}

#------------------------------------------------------------------------------
# Init / Setup
#------------------------------------------------------------------------------

init_projects() {
    echo -e "${BOLD}Scanning ~/code for projects...${NC}"
    echo ""

    local code_dir="$HOME/code"
    local added=0

    for repo_dir in "$code_dir"/*; do
        [[ ! -d "$repo_dir" ]] && continue
        [[ ! -d "$repo_dir/.git" ]] && continue

        local repo_name
        repo_name=$(basename "$repo_dir")

        # Check if already configured
        if [[ -n "$(get_project_config "$repo_name")" ]]; then
            echo -e "  ${DIM}âœ“ $repo_name (already configured)${NC}"
            continue
        fi

        # Auto-detect port from package.json if exists
        local port=""
        if [[ -f "$repo_dir/package.json" ]]; then
            # Try to find a port in scripts
            port=$(jq -r '.scripts.dev // ""' "$repo_dir/package.json" 2>/dev/null | grep -oE -- '--port[= ]+[0-9]+' | grep -oE '[0-9]+' | head -1 || true)
        fi

        # Generate a color based on repo name hash
        local hash
        hash=$(echo -n "$repo_name" | md5sum | cut -c1-6)
        local r=$((16#${hash:0:2}))
        local g=$((16#${hash:2:2}))
        local b=$((16#${hash:4:2}))
        local active_color="rgb($(printf '%02x%02x%02x' $r $g $b))"
        local inactive_color="rgb($(printf '%02x%02x%02x' $((r*3/4)) $((g*3/4)) $((b*3/4))))"

        # Add to config
        local new_project
        new_project=$(cat << EOF
{
  "name": "${repo_name^^}",
  "path": "~/code/$repo_name",
  "port": ${port:-null},
  "database_url": null,
  "active_color": "$active_color",
  "inactive_color": "$inactive_color"
}
EOF
)

        # Update config file
        local tmp_file
        tmp_file=$(mktemp)
        jq ".projects[\"$repo_name\"] = $new_project" "$CONFIG_FILE" > "$tmp_file"
        mv "$tmp_file" "$CONFIG_FILE"

        echo -e "  ${GREEN}+ $repo_name${NC}"
        added=$((added + 1))
    done

    echo ""
    if [[ $added -gt 0 ]]; then
        echo -e "${GREEN}Added $added project(s) to config${NC}"
    else
        echo -e "${DIM}No new projects found${NC}"
    fi
    echo ""
    echo "Edit config: $CONFIG_FILE"
}

show_config() {
    local project="$1"

    if [[ -z "$project" ]]; then
        # Show all config
        cat "$CONFIG_FILE" | jq .
    else
        local config
        config=$(get_project_config "$project")
        if [[ -z "$config" ]]; then
            echo -e "${RED}Unknown project: $project${NC}"
            return 1
        fi
        echo "$config" | jq .
    fi
}

edit_config() {
    ${EDITOR:-vim} "$CONFIG_FILE"
}

#------------------------------------------------------------------------------
# List Projects
#------------------------------------------------------------------------------

list_all() {
    ensure_config

    echo ""
    echo -e "${BOLD}Configured Projects:${NC}"
    echo ""

    local projects
    projects=$(list_projects)

    if [[ -z "$projects" ]]; then
        echo -e "  ${DIM}No projects configured${NC}"
        echo ""
        echo "  Run: jat init"
        return 0
    fi

    # Table header
    printf "  ${DIM}%-15s %-8s %-20s${NC}\n" "PROJECT" "PORT" "COLOR"
    printf "  ${DIM}%-15s %-8s %-20s${NC}\n" "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    for project in $projects; do
        local config
        config=$(get_project_config "$project")
        local port active_color
        port=$(echo "$config" | jq -r '.port // "-"')
        active_color=$(echo "$config" | jq -r '.active_color // "-"')

        printf "  %-15s %-8s %-20s\n" "$project" "$port" "$active_color"
    done

    echo ""
    echo -e "${DIM}Usage: jat <project> [--code|--claude|--npm|--browser]${NC}"
    echo ""
}

#------------------------------------------------------------------------------
# Help
#------------------------------------------------------------------------------

show_help() {
    cat << 'EOF'

JAT CLI - Launch complete dev environments

USAGE:
    jat <project>              Launch full environment (VS Code + Claude + npm + browser)
    jat <project> [N]          Launch with N Claude Code sessions (default: 1)
    jat <project> --claude     Launch only Claude Code
    jat <project> --code       Launch only VS Code
    jat <project> --npm        Launch only dev server
    jat <project> --browser    Open browser to dev server

COMMANDS:
    jat list                   Show all configured projects
    jat init                   Auto-detect projects in ~/code
    jat config [project]       Show config (all or specific project)
    jat edit                   Edit config file
    jat colors                 Recolor all Hyprland windows

OPTIONS:
    N               Number of Claude Code sessions to launch (1-10)
    --no-agent      Skip /agent:start prompt (raw Claude without auto-registration)
    -c, --code      Launch VS Code only
    -l, --claude    Launch Claude Code only
    -n, --npm       Launch npm dev server only
    -b, --browser   Open browser only
    -a, --all       Launch everything (default)

EXAMPLES:
    jat chimaro                # Full environment (1 Claude session)
    jat chimaro 4              # Full environment with 4 Claude sessions
    jat chimaro 4 --claude     # Only 4 Claude sessions (no VS Code/npm)
    jat chimaro --no-agent     # Claude without /agent:start auto-registration
    jat jat --code --npm       # VS Code + dev server
    jat init                   # Scan ~/code for projects

CONFIG:
    ~/.config/jat/projects.json

EOF
}

#------------------------------------------------------------------------------
# Main
#------------------------------------------------------------------------------

main() {
    ensure_config

    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local cmd="$1"
    shift

    case "$cmd" in
        help|--help|-h)
            show_help
            ;;
        list|ls)
            list_all
            ;;
        init)
            init_projects
            ;;
        config)
            show_config "$@"
            ;;
        edit)
            edit_config
            ;;
        colors)
            apply_all_colors
            ;;
        *)
            # Assume it's a project name
            launch_project "$cmd" "$@"
            ;;
    esac
}

main "$@"
