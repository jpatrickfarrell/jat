#!/bin/bash

# bd-check-review - Preview what review action would be taken for a task
#
# Shows whether a task would auto-proceed or require human review
# based on the current review rules configuration.
#
# Usage:
#   bd-check-review <task-id>          # Check single task
#   bd-check-review <task-id> --json   # Output as JSON
#   bd-check-review --batch            # Check all open/in_progress tasks
#
# Examples:
#   bd-check-review jat-abc
#   bd-check-review jat-xyz --json
#   bd-check-review --batch

set -e

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Icons
CHECK_ICON="‚úì"
REVIEW_ICON="üëÅ"
AUTO_ICON="‚ö°"

# Default values
DEFAULT_ACTION="review"
DEFAULT_MAX_AUTO=3

# Parse arguments
TASK_ID=""
JSON_OUTPUT=false
BATCH_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --json|-j)
            JSON_OUTPUT=true
            shift
            ;;
        --batch|-b)
            BATCH_MODE=true
            shift
            ;;
        --help|-h)
            echo "bd-check-review - Preview review action for a task"
            echo ""
            echo "Usage:"
            echo "  bd-check-review <task-id>          Check single task"
            echo "  bd-check-review <task-id> --json   Output as JSON"
            echo "  bd-check-review --batch            Check all open/in_progress tasks"
            echo ""
            echo "Options:"
            echo "  --json, -j    Output result as JSON"
            echo "  --batch, -b   Check all active tasks"
            echo "  --help, -h    Show this help"
            echo ""
            echo "Output explains:"
            echo "  ‚Ä¢ Whether task would auto-proceed or require review"
            echo "  ‚Ä¢ Why (which rule matched)"
            echo "  ‚Ä¢ What priority threshold applied"
            echo ""
            echo "Examples:"
            echo "  bd-check-review jat-abc"
            echo "  bd-check-review jat-xyz --json"
            echo "  bd-check-review --batch | grep 'requires review'"
            exit 0
            ;;
        *)
            if [ -z "$TASK_ID" ]; then
                TASK_ID="$1"
            else
                echo -e "${RED}Unknown option: $1${NC}" >&2
                echo "Use --help for usage information" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate arguments
if [ "$BATCH_MODE" = false ] && [ -z "$TASK_ID" ]; then
    echo -e "${RED}Error: Task ID required${NC}" >&2
    echo "Usage: bd-check-review <task-id>" >&2
    echo "       bd-check-review --batch" >&2
    exit 1
fi

# Function to get a config value with default
get_config() {
    local key="$1"
    local default="$2"
    local value
    value=$(bd config get "$key" 2>/dev/null || echo "")
    # bd config get returns "key (not set)" if not set
    if [ -z "$value" ] || [ "$value" = "null" ] || [[ "$value" == *"(not set)"* ]]; then
        echo "$default"
    else
        echo "$value"
    fi
}

# Function to get priority name
priority_name() {
    local p="$1"
    case $p in
        0) echo "P0 (Critical)" ;;
        1) echo "P1 (High)" ;;
        2) echo "P2 (Medium)" ;;
        3) echo "P3 (Low)" ;;
        4) echo "P4 (Lowest)" ;;
        *) echo "P$p" ;;
    esac
}

# Function to check a single task
check_task() {
    local task_id="$1"
    local json_mode="$2"

    # Get task details
    local task_json
    task_json=$(bd show "$task_id" --json 2>/dev/null) || {
        if [ "$json_mode" = true ]; then
            echo "{\"error\": \"Task not found: $task_id\"}"
        else
            echo -e "${RED}Error: Task not found: $task_id${NC}" >&2
        fi
        return 1
    }

    # Parse task fields
    local task_type task_priority task_title task_status task_override task_notes
    task_type=$(echo "$task_json" | jq -r '.[0].issue_type // "task"')
    task_priority=$(echo "$task_json" | jq -r '.[0].priority // 2')
    task_title=$(echo "$task_json" | jq -r '.[0].title // "Unknown"')
    task_status=$(echo "$task_json" | jq -r '.[0].status // "unknown"')
    # Parse review_override from notes field (stored as [REVIEW_OVERRIDE:value])
    task_notes=$(echo "$task_json" | jq -r '.[0].notes // ""')
    task_override=$(echo "$task_notes" | grep -oP '\[REVIEW_OVERRIDE:\K[^\]]+' || echo "null")
    if [ -z "$task_override" ]; then task_override="null"; fi

    # Handle null/empty type
    if [ "$task_type" = "null" ] || [ -z "$task_type" ]; then
        task_type="task"
    fi

    # Get default action and type-specific rule
    local default_action max_auto
    default_action=$(get_config "review_rules.default_action" "$DEFAULT_ACTION")
    max_auto=$(get_config "review_rules.$task_type.max_auto" "$DEFAULT_MAX_AUTO")

    # Determine action and reason
    local action reason rule_source

    # Check for JSON file override (centralized rules)
    local json_override=""
    if command -v bd-review-rules-loader &>/dev/null; then
        json_override=$(bd-review-rules-loader --get-override "$task_id" 2>/dev/null || echo "none")
    fi

    # Check for task-level override first (stored on task itself)
    if [ "$task_override" = "always_review" ]; then
        action="review"
        reason="Task has review_override=always_review"
        rule_source="override"
    elif [ "$task_override" = "always_auto" ]; then
        action="auto"
        reason="Task has review_override=always_auto"
        rule_source="override"
    # Then check JSON file override
    elif [ "$json_override" = "always_review" ]; then
        action="review"
        reason="Override in review-rules.json"
        rule_source="json_override"
    elif [ "$json_override" = "always_auto" ]; then
        action="auto"
        reason="Override in review-rules.json"
        rule_source="json_override"
    else
        # Apply type-specific rule
        if [ "$max_auto" -lt 0 ]; then
            # All priorities require review
            action="review"
            reason="Type '$task_type' requires review for all priorities (max_auto=-1)"
            rule_source="type_rule"
        elif [ "$task_priority" -le "$max_auto" ]; then
            # Priority within auto-proceed range
            action="auto"
            reason="Priority P$task_priority <= max_auto P$max_auto for type '$task_type'"
            rule_source="type_rule"
        else
            # Priority exceeds auto-proceed threshold
            action="review"
            reason="Priority P$task_priority > max_auto P$max_auto for type '$task_type'"
            rule_source="type_rule"
        fi
    fi

    # Output result
    if [ "$json_mode" = true ]; then
        jq -n \
            --arg id "$task_id" \
            --arg title "$task_title" \
            --arg type "$task_type" \
            --argjson priority "$task_priority" \
            --arg status "$task_status" \
            --arg action "$action" \
            --arg reason "$reason" \
            --arg rule_source "$rule_source" \
            --argjson max_auto "$max_auto" \
            '{
                task_id: $id,
                title: $title,
                type: $type,
                priority: $priority,
                status: $status,
                review_action: $action,
                reason: $reason,
                rule_source: $rule_source,
                max_auto_priority: $max_auto
            }'
    else
        echo ""
        echo -e "${BOLD}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${BOLD}‚ïë                    üîç Review Check: $task_id${NC}"
        printf "${BOLD}%-76s${NC}\n" "‚ïë"
        echo -e "${BOLD}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""

        # Task info
        echo -e "  ${CYAN}Task:${NC} $task_title"
        echo -e "  ${CYAN}Type:${NC} $task_type"
        echo -e "  ${CYAN}Priority:${NC} $(priority_name "$task_priority")"
        echo -e "  ${CYAN}Status:${NC} $task_status"
        echo ""

        # Rule applied
        echo -e "  ${CYAN}Rule applied:${NC}"
        if [ "$rule_source" = "override" ]; then
            echo -e "    ${DIM}Source: Task-level override${NC}"
        else
            echo -e "    ${DIM}Source: Type rule (review_rules.$task_type.max_auto = $max_auto)${NC}"
        fi
        echo ""

        # Decision
        echo -e "  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
        if [ "$action" = "auto" ]; then
            echo -e "  ‚îÇ  ${GREEN}${AUTO_ICON} DECISION: AUTO-PROCEED${NC}                                          ‚îÇ"
            echo -e "  ‚îÇ                                                                        ‚îÇ"
            echo -e "  ‚îÇ  This task will close automatically when the agent marks it complete.  ‚îÇ"
        else
            echo -e "  ‚îÇ  ${YELLOW}${REVIEW_ICON} DECISION: REQUIRES REVIEW${NC}                                        ‚îÇ"
            echo -e "  ‚îÇ                                                                        ‚îÇ"
            echo -e "  ‚îÇ  This task will wait for human review before closing.                  ‚îÇ"
        fi
        echo -e "  ‚îÇ                                                                        ‚îÇ"
        echo -e "  ‚îÇ  ${DIM}Reason: ${reason:0:60}${NC}"
        if [ ${#reason} -gt 60 ]; then
            echo -e "  ‚îÇ  ${DIM}        ${reason:60:60}${NC}"
        fi
        echo -e "  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
        echo ""

        # Actionable info
        if [ "$action" = "review" ]; then
            echo -e "  ${CYAN}To change this behavior:${NC}"
            echo "    ‚Ä¢ Increase max_auto: bd-review-rules --type $task_type --max-auto $task_priority"
            echo "    ‚Ä¢ Set task override: bd-set-review-override $task_id always_auto"
            echo ""
        fi
    fi
}

# Batch mode - check all active tasks
if [ "$BATCH_MODE" = true ]; then
    # Get all open and in_progress tasks
    tasks=$(bd list --status open --json 2>/dev/null | jq -r '.[].id' 2>/dev/null || echo "")
    tasks_in_progress=$(bd list --status in_progress --json 2>/dev/null | jq -r '.[].id' 2>/dev/null || echo "")

    # Combine and deduplicate
    all_tasks=$(echo -e "$tasks\n$tasks_in_progress" | sort -u | grep -v '^$' || true)

    if [ -z "$all_tasks" ]; then
        if [ "$JSON_OUTPUT" = true ]; then
            echo "[]"
        else
            echo -e "${YELLOW}No open or in_progress tasks found${NC}"
        fi
        exit 0
    fi

    if [ "$JSON_OUTPUT" = true ]; then
        # JSON array output
        echo "["
        first=true
        while IFS= read -r task_id; do
            if [ -n "$task_id" ]; then
                if [ "$first" = true ]; then
                    first=false
                else
                    echo ","
                fi
                check_task "$task_id" true
            fi
        done <<< "$all_tasks"
        echo "]"
    else
        # Human-readable table
        echo ""
        echo -e "${BOLD}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${BOLD}‚ïë                    üìã Review Check: All Active Tasks                     ‚ïë${NC}"
        echo -e "${BOLD}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""

        echo -e "  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
        echo -e "  ‚îÇ ${BOLD}Task ID${NC}       ‚îÇ ${BOLD}Type${NC}     ‚îÇ ${BOLD}Priority${NC} ‚îÇ ${BOLD}Action${NC}   ‚îÇ ${BOLD}Reason${NC}                  ‚îÇ"
        echo -e "  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"

        while IFS= read -r task_id; do
            if [ -n "$task_id" ]; then
                # Get task details
                task_json=$(bd show "$task_id" --json 2>/dev/null) || continue
                task_type=$(echo "$task_json" | jq -r '.[0].issue_type // "task"')
                task_priority=$(echo "$task_json" | jq -r '.[0].priority // 2')
                # Parse review_override from notes field
                task_notes=$(echo "$task_json" | jq -r '.[0].notes // ""')
                task_override=$(echo "$task_notes" | grep -oP '\[REVIEW_OVERRIDE:\K[^\]]+' || echo "null")
                if [ -z "$task_override" ]; then task_override="null"; fi

                # Handle null/empty type
                if [ "$task_type" = "null" ] || [ -z "$task_type" ]; then
                    task_type="task"
                fi

                # Get rule
                max_auto=$(get_config "review_rules.$task_type.max_auto" "$DEFAULT_MAX_AUTO")

                # Check JSON override
                json_override=""
                if command -v bd-review-rules-loader &>/dev/null; then
                    json_override=$(bd-review-rules-loader --get-override "$task_id" 2>/dev/null || echo "none")
                fi

                # Determine action
                if [ "$task_override" = "always_review" ]; then
                    action="review"
                    reason="override"
                elif [ "$task_override" = "always_auto" ]; then
                    action="auto"
                    reason="override"
                elif [ "$json_override" = "always_review" ]; then
                    action="review"
                    reason="json override"
                elif [ "$json_override" = "always_auto" ]; then
                    action="auto"
                    reason="json override"
                elif [ "$max_auto" -lt 0 ]; then
                    action="review"
                    reason="type rule"
                elif [ "$task_priority" -le "$max_auto" ]; then
                    action="auto"
                    reason="P$task_priority <= P$max_auto"
                else
                    action="review"
                    reason="P$task_priority > P$max_auto"
                fi

                # Format columns
                id_col=$(printf "%-13s" "$task_id")
                type_col=$(printf "%-8s" "$task_type")
                priority_col=$(printf "%-7s" "P$task_priority")
                reason_col=$(printf "%-23s" "$reason")

                if [ "$action" = "auto" ]; then
                    action_col="${GREEN}$(printf "%-8s" "auto")${NC}"
                else
                    action_col="${YELLOW}$(printf "%-8s" "review")${NC}"
                fi

                echo -e "  ‚îÇ $id_col ‚îÇ $type_col ‚îÇ $priority_col ‚îÇ $action_col ‚îÇ $reason_col ‚îÇ"
            fi
        done <<< "$all_tasks"

        echo -e "  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
        echo ""

        # Summary
        auto_count=$(echo "$all_tasks" | while IFS= read -r tid; do
            if [ -n "$tid" ]; then
                tj=$(bd show "$tid" --json 2>/dev/null) || continue
                tt=$(echo "$tj" | jq -r '.[0].issue_type // "task"')
                tp=$(echo "$tj" | jq -r '.[0].priority // 2')
                # Parse review_override from notes field
                tn=$(echo "$tj" | jq -r '.[0].notes // ""')
                to=$(echo "$tn" | grep -oP '\[REVIEW_OVERRIDE:\K[^\]]+' || echo "null")
                if [ -z "$to" ]; then to="null"; fi
                if [ "$tt" = "null" ] || [ -z "$tt" ]; then tt="task"; fi
                ma=$(get_config "review_rules.$tt.max_auto" "$DEFAULT_MAX_AUTO")
                # Check JSON override
                jo=""
                if command -v bd-review-rules-loader &>/dev/null; then
                    jo=$(bd-review-rules-loader --get-override "$tid" 2>/dev/null || echo "none")
                fi
                if [ "$to" = "always_auto" ]; then echo "auto"
                elif [ "$to" = "always_review" ]; then :
                elif [ "$jo" = "always_auto" ]; then echo "auto"
                elif [ "$jo" = "always_review" ]; then :
                elif [ "$ma" -lt 0 ]; then :
                elif [ "$tp" -le "$ma" ]; then echo "auto"
                fi
            fi
        done | wc -l)

        total_count=$(echo "$all_tasks" | grep -c . || echo 0)
        review_count=$((total_count - auto_count))

        echo -e "  ${CYAN}Summary:${NC}"
        echo -e "    ${GREEN}${AUTO_ICON}${NC} Auto-proceed: $auto_count tasks"
        echo -e "    ${YELLOW}${REVIEW_ICON}${NC} Require review: $review_count tasks"
        echo -e "    Total: $total_count tasks"
        echo ""
    fi
    exit 0
fi

# Single task mode
check_task "$TASK_ID" "$JSON_OUTPUT"
