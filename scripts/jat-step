#!/bin/bash
#
# jat-step - Execute a completion step with automatic signal emission
#
# Usage:
#   jat-step <step> --task <id> --title <title> --agent <name> [options]
#
# Steps:
#   verifying   - Emit signal only (agent does verification)
#   committing  - Emit signal + git add/commit
#   closing     - Emit signal + bd close
#   releasing   - Emit signal + release all reservations
#   announcing  - Emit signal + am-send completion announcement
#
# Options:
#   --task <id>       Task ID (required)
#   --title <title>   Task title (required)
#   --agent <name>    Agent name (required)
#   --type <type>     Task type for commit message (default: task)
#   --help            Show this help
#
# Example:
#   jat-step verifying --task jat-abc --title "Add auth" --agent FreeOcean
#   jat-step committing --task jat-abc --title "Add auth" --agent FreeOcean --type feature
#   jat-step closing --task jat-abc --title "Add auth" --agent FreeOcean

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
DIM='\033[2m'
NC='\033[0m'

log() { echo -e "$@" >&2; }
log_dim() { echo -e "${DIM}$@${NC}" >&2; }
log_error() { echo -e "${RED}Error: $@${NC}" >&2; }
log_success() { echo -e "${GREEN}$@${NC}" >&2; }

show_usage() {
    cat >&2 <<'EOF'
jat-step - Execute a completion step with automatic signal emission

Usage:
  jat-step <step> --task <id> --title <title> --agent <name> [options]

Steps:
  verifying   - Emit signal only (agent does verification)
  committing  - Emit signal + git add/commit
  closing     - Emit signal + bd close
  releasing   - Emit signal + release all reservations
  announcing  - Emit signal + am-send completion announcement
  complete    - Generate completion bundle via LLM and emit complete signal

Options:
  --task <id>       Task ID (required)
  --title <title>   Task title (required)
  --agent <name>    Agent name (required)
  --type <type>     Task type for commit message (default: task)
  --help            Show this help

Example:
  jat-step verifying --task jat-abc --title "Add auth" --agent FreeOcean
  jat-step committing --task jat-abc --title "Add auth" --agent FreeOcean --type feature
  jat-step closing --task jat-abc --title "Add auth" --agent FreeOcean
EOF
    exit 0
}

# Step definitions: name -> [progress, stepsCompleted, stepsRemaining, description]
get_step_config() {
    local step="$1"
    case "$step" in
        verifying)
            echo '0|[]|["verifying","committing","closing","releasing","announcing"]|Running tests and verification'
            ;;
        committing)
            echo '20|["verifying"]|["committing","closing","releasing","announcing"]|Committing changes'
            ;;
        closing)
            echo '40|["verifying","committing"]|["closing","releasing","announcing"]|Closing task in Beads'
            ;;
        releasing)
            echo '60|["verifying","committing","closing"]|["releasing","announcing"]|Releasing file reservations'
            ;;
        announcing)
            echo '80|["verifying","committing","closing","releasing"]|["announcing"]|Announcing completion via Agent Mail'
            ;;
        complete)
            # complete step doesn't emit completing signal - it emits the complete signal
            echo '100|["verifying","committing","closing","releasing","announcing"]|[]|Generating completion bundle'
            ;;
        *)
            log_error "Unknown step: $step"
            log "Valid steps: verifying, committing, closing, releasing, announcing, complete"
            exit 1
            ;;
    esac
}

emit_completing_signal() {
    local step="$1"
    local task_id="$2"
    local task_title="$3"
    local config
    config=$(get_step_config "$step")

    local progress completed remaining description
    IFS='|' read -r progress completed remaining description <<< "$config"

    local timestamp
    timestamp=$(date -Iseconds)

    jat-signal completing "$(jq -n -c \
        --arg taskId "$task_id" \
        --arg taskTitle "$task_title" \
        --arg currentStep "$step" \
        --argjson stepsCompleted "$completed" \
        --argjson stepsRemaining "$remaining" \
        --argjson progress "$progress" \
        --arg stepDescription "$description" \
        --arg stepStartedAt "$timestamp" \
        '{
            taskId: $taskId,
            taskTitle: $taskTitle,
            currentStep: $currentStep,
            stepsCompleted: $stepsCompleted,
            stepsRemaining: $stepsRemaining,
            progress: $progress,
            stepDescription: $stepDescription,
            stepStartedAt: $stepStartedAt
        }')"
}

# Parse arguments
STEP=""
TASK_ID=""
TASK_TITLE=""
AGENT_NAME=""
TASK_TYPE="task"

# First argument is the step
if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
    STEP="$1"
    shift
fi

while [[ $# -gt 0 ]]; do
    case $1 in
        --task)
            TASK_ID="$2"
            shift 2
            ;;
        --title)
            TASK_TITLE="$2"
            shift 2
            ;;
        --agent)
            AGENT_NAME="$2"
            shift 2
            ;;
        --type)
            TASK_TYPE="$2"
            shift 2
            ;;
        --help|-h)
            show_usage
            ;;
        *)
            if [[ -z "$STEP" ]]; then
                STEP="$1"
                shift
            else
                log_error "Unknown option: $1"
                show_usage
            fi
            ;;
    esac
done

# Validate required arguments
if [[ -z "$STEP" ]]; then
    log_error "Step is required"
    show_usage
fi

if [[ -z "$TASK_ID" ]]; then
    log_error "Task ID is required (--task <id>)"
    exit 1
fi

if [[ -z "$TASK_TITLE" ]]; then
    log_error "Task title is required (--title <title>)"
    exit 1
fi

if [[ -z "$AGENT_NAME" ]]; then
    log_error "Agent name is required (--agent <name>)"
    exit 1
fi

# Execute the step
case "$STEP" in
    verifying)
        # Just emit signal - agent does verification
        emit_completing_signal "$STEP" "$TASK_ID" "$TASK_TITLE"
        log_success "Ready for verification"
        ;;

    committing)
        emit_completing_signal "$STEP" "$TASK_ID" "$TASK_TITLE"

        # Check if there are changes to commit
        if [[ -n "$(git status --porcelain 2>/dev/null)" ]]; then
            log_dim "Adding and committing changes..."
            git add .
            git commit -m "$(cat <<EOF
${TASK_TYPE}(${TASK_ID}): ${TASK_TITLE}

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
            log_success "Changes committed"
        else
            log_dim "No changes to commit"
        fi
        ;;

    closing)
        emit_completing_signal "$STEP" "$TASK_ID" "$TASK_TITLE"

        log_dim "Closing task in Beads..."
        bd close "$TASK_ID" --reason "Completed by $AGENT_NAME"
        log_success "Task closed: $TASK_ID"
        ;;

    releasing)
        emit_completing_signal "$STEP" "$TASK_ID" "$TASK_TITLE"

        log_dim "Releasing file reservations..."
        # Get all reservations for this agent and release them
        reservations=$(am-reservations --agent "$AGENT_NAME" --json 2>/dev/null || echo "[]")

        if [[ "$reservations" != "[]" && -n "$reservations" ]]; then
            echo "$reservations" | jq -r '.[].path_pattern' | while read -r pattern; do
                if [[ -n "$pattern" ]]; then
                    am-release "$pattern" --agent "$AGENT_NAME" 2>/dev/null || true
                    log_dim "  Released: $pattern"
                fi
            done
            log_success "Reservations released"
        else
            log_dim "No reservations to release"
        fi
        ;;

    announcing)
        emit_completing_signal "$STEP" "$TASK_ID" "$TASK_TITLE"

        log_dim "Announcing completion..."
        am-send "[$TASK_ID] Completed: $TASK_TITLE" \
            "Task completed by $AGENT_NAME.

Status: Complete
Type: $TASK_TYPE
Verification: Full (tests, lint, security)" \
            --from "$AGENT_NAME" \
            --to @active \
            --thread "$TASK_ID"
        log_success "Completion announced"
        ;;

    complete)
        # No completing signal - this step emits the final complete signal
        log_dim "Generating completion bundle via LLM..."
        jat-complete-bundle --task "$TASK_ID" --agent "$AGENT_NAME" --emit
        log_success "Completion bundle emitted"
        ;;

    *)
        log_error "Unknown step: $STEP"
        exit 1
        ;;
esac
