#!/usr/bin/env bash
# Reply to a message
# Usage: am-reply MESSAGE_ID "Reply body" --agent AgentName [--to Agent1,Agent2] [--importance high]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/am-lib.sh"

# Parse arguments
MESSAGE_ID=""
REPLY_BODY=""
AGENT_NAME=""
TO_AGENTS=""  # Optional: override recipients
IMPORTANCE="normal"
PROJECT="$PROJECT_KEY"
ACK_REQUIRED=0

show_help() {
    cat <<EOF
Usage: am-reply MESSAGE_ID "Body" --agent AGENT [options]

Reply to a message. By default, replies to the sender. Use --to to override recipients.

Arguments:
  MESSAGE_ID          ID of the message to reply to (required)
  BODY                Reply body in markdown (required)

Options:
  --agent AGENT       Replying agent name (required)
  --to AGENTS         Override recipients (comma-separated, default: sender)
  --importance LEVEL  Message importance: normal | high | urgent (default: normal)
  --ack               Require acknowledgment (default: false)
  --project PATH      Project path (default: current directory)
  --help, -h          Show this help

Examples:
  am-reply 5 "Thanks for the update!" --agent Bob
  am-reply 12 "Please review" --agent Alice --to Bob,Carol --importance high --ack

Database: $AGENT_MAIL_DB
EOF
}

# First two positional args are message ID and body
if [[ $# -ge 2 ]] && [[ ! "$1" =~ ^-- ]]; then
    MESSAGE_ID="$1"
    shift
    REPLY_BODY="$1"
    shift
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        --agent)
            AGENT_NAME="$2"
            shift 2
            ;;
        --to)
            TO_AGENTS="$2"
            shift 2
            ;;
        --importance)
            IMPORTANCE="$2"
            shift 2
            ;;
        --ack)
            ACK_REQUIRED=1
            shift
            ;;
        --project)
            PROJECT="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            am_error "Unknown option: $1"
            ;;
    esac
done

# Validate required arguments
if [[ -z "$MESSAGE_ID" ]]; then
    am_error "Message ID is required"
fi

if [[ -z "$REPLY_BODY" ]]; then
    am_error "Reply body is required"
fi

if [[ -z "$AGENT_NAME" ]]; then
    am_error "--agent is required"
fi

# Validate message ID is a number
if ! [[ "$MESSAGE_ID" =~ ^[0-9]+$ ]]; then
    am_error "Message ID must be a number"
fi

# Validate importance level
if [[ ! "$IMPORTANCE" =~ ^(normal|high|urgent)$ ]]; then
    am_error "Importance must be: normal, high, or urgent"
fi

# Get or create project
PROJECT_ID=$(am_get_project "$AGENT_MAIL_DB" "$PROJECT")

# Validate agent exists
AGENT_ID=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM agents WHERE project_id = $PROJECT_ID AND name = '$AGENT_NAME';")
if [[ -z "$AGENT_ID" ]]; then
    am_error "Agent '$AGENT_NAME' not found. Run: am-register --name $AGENT_NAME"
fi

# Update agent's last_active
am_touch_agent "$AGENT_MAIL_DB" "$AGENT_ID"

# Fetch original message details
ORIGINAL=$(sqlite3 -json "$AGENT_MAIL_DB" <<SQL
SELECT
    m.subject,
    m.thread_id,
    a.name as sender_name,
    a.id as sender_id
FROM messages m
JOIN agents a ON m.sender_id = a.id
WHERE m.id = $MESSAGE_ID AND m.project_id = $PROJECT_ID;
SQL
)

if [[ $(echo "$ORIGINAL" | jq '. | length') == "0" ]]; then
    am_error "Message $MESSAGE_ID not found in this project"
fi

ORIGINAL_SUBJECT=$(echo "$ORIGINAL" | jq -r '.[0].subject')
THREAD_ID=$(echo "$ORIGINAL" | jq -r '.[0].thread_id // ""')
SENDER_NAME=$(echo "$ORIGINAL" | jq -r '.[0].sender_name')
SENDER_ID=$(echo "$ORIGINAL" | jq -r '.[0].sender_id')

# Build reply subject
REPLY_SUBJECT="Re: $ORIGINAL_SUBJECT"

# Determine recipients
if [[ -z "$TO_AGENTS" ]]; then
    # Default: reply to sender (if sender is not us)
    if [[ "$SENDER_ID" == "$AGENT_ID" ]]; then
        am_error "Cannot reply to yourself. Use --to to specify recipients."
    fi
    TO_AGENTS="$SENDER_NAME"
fi

# Escape single quotes in subject and body
SUBJECT_ESC="${REPLY_SUBJECT//\'/\'\'}"
BODY_ESC="${REPLY_BODY//\'/\'\'}"
THREAD_ID_ESC="${THREAD_ID//\'/\'\'}"

# Create reply message
REPLY_ID=$(sqlite3 "$AGENT_MAIL_DB" <<SQL
INSERT INTO messages (project_id, sender_id, thread_id, subject, body_md, importance, ack_required)
VALUES ($PROJECT_ID, $AGENT_ID, $([ -n "$THREAD_ID_ESC" ] && echo "'$THREAD_ID_ESC'" || echo "NULL"), '$SUBJECT_ESC', '$BODY_ESC', '$IMPORTANCE', $ACK_REQUIRED);
SELECT last_insert_rowid();
SQL
)

# Add recipients
IFS=',' read -ra TO_ARRAY <<< "$TO_AGENTS"
for agent_name in "${TO_ARRAY[@]}"; do
    agent_name=$(echo "$agent_name" | xargs)  # trim whitespace
    RECIPIENT_ID=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM agents WHERE project_id = $PROJECT_ID AND name = '$agent_name';")
    if [[ -z "$RECIPIENT_ID" ]]; then
        am_error "Recipient agent '$agent_name' not found. Run: am-register --name $agent_name"
    fi
    sqlite3 "$AGENT_MAIL_DB" "INSERT INTO message_recipients (message_id, agent_id, kind) VALUES ($REPLY_ID, $RECIPIENT_ID, 'to');"
done

am_success "Reply sent (ID: $REPLY_ID)"
echo "  To: $TO_AGENTS"
echo "  Subject: $REPLY_SUBJECT"
[[ -n "$THREAD_ID" ]] && echo "  Thread: $THREAD_ID"
