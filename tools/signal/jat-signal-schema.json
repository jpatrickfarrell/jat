{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "jat-signal-schema.json",
  "description": "JSON Schema for jat-signal payloads (thin and rich signals)",
  "definitions": {
    "signalState": {
      "type": "string",
      "enum": ["working", "review", "idle", "needs_input", "starting", "compacting", "completing"],
      "description": "Valid state signal values"
    },
    "estimatedScope": {
      "type": "string",
      "enum": ["small", "medium", "large"],
      "description": "Estimated scope of work"
    },
    "changeType": {
      "type": "string",
      "enum": ["added", "modified", "deleted"],
      "description": "Type of file change"
    },
    "questionType": {
      "type": "string",
      "enum": ["choice", "text", "approval", "clarification"],
      "description": "Type of question being asked"
    },
    "completionStep": {
      "type": "string",
      "enum": ["verifying", "committing", "closing", "releasing", "announcing"],
      "description": "Step in completion workflow"
    },
    "gitStatus": {
      "type": "string",
      "enum": ["clean", "dirty"],
      "description": "Git working tree status"
    },
    "suggestedTask": {
      "type": "object",
      "description": "A task suggested by an agent for follow-up work",
      "required": ["title"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Optional existing task ID this references"
        },
        "type": {
          "type": "string",
          "enum": ["bug", "feature", "task", "chore", "epic"],
          "description": "Task type"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Task title"
        },
        "description": {
          "type": "string",
          "maxLength": 2000,
          "description": "Task description"
        },
        "priority": {
          "type": "integer",
          "minimum": 0,
          "maximum": 4,
          "description": "Priority level: 0=critical, 4=lowest"
        },
        "reason": {
          "type": "string",
          "maxLength": 500,
          "description": "Why this task was suggested"
        },
        "project": {
          "type": "string",
          "pattern": "^[a-z0-9_-]+$",
          "description": "Project identifier"
        },
        "labels": {
          "type": "string",
          "description": "Comma-separated labels"
        },
        "depends_on": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Task IDs this task depends on"
        }
      }
    },
    "humanAction": {
      "type": "object",
      "description": "An action requiring human intervention",
      "required": ["title"],
      "additionalProperties": false,
      "properties": {
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Action title"
        },
        "description": {
          "type": "string",
          "maxLength": 2000,
          "description": "Action description"
        },
        "items": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Checklist items for multi-step actions"
        }
      }
    },
    "qualitySignals": {
      "type": "object",
      "description": "Quality signals from completed task",
      "additionalProperties": false,
      "properties": {
        "tests": {
          "type": "string",
          "enum": ["passing", "failing", "none", "skipped"],
          "description": "Test status"
        },
        "build": {
          "type": "string",
          "enum": ["clean", "warnings", "errors"],
          "description": "Build status"
        },
        "preExisting": {
          "type": "string",
          "description": "Note about pre-existing issues"
        }
      }
    },
    "crossAgentIntel": {
      "type": "object",
      "description": "Intelligence for other agents",
      "additionalProperties": false,
      "properties": {
        "files": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Key files modified"
        },
        "patterns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Coding patterns/conventions to follow"
        },
        "gotchas": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Non-obvious issues or gotchas"
        }
      }
    },
    "completeSignal": {
      "type": "object",
      "description": "Full completion bundle from agent. Used by jat-signal complete command.",
      "additionalProperties": false,
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Task ID that was completed"
        },
        "agentName": {
          "type": "string",
          "description": "Agent name that completed the task"
        },
        "completionMode": {
          "type": "string",
          "enum": ["review_required", "auto_proceed"],
          "description": "How completion should be handled: review_required (wait for human), auto_proceed (pick next task)"
        },
        "nextTaskId": {
          "type": "string",
          "description": "Next task to pick up (only for auto_proceed mode)"
        },
        "nextTaskTitle": {
          "type": "string",
          "description": "Title of next task (only for auto_proceed mode)"
        },
        "summary": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Array of accomplishment bullet points"
        },
        "quality": {
          "$ref": "#/definitions/qualitySignals"
        },
        "humanActions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/humanAction"
          },
          "description": "Human actions required"
        },
        "suggestedTasks": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/suggestedTask"
          },
          "description": "Follow-up tasks discovered during work"
        },
        "crossAgentIntel": {
          "$ref": "#/definitions/crossAgentIntel"
        },
        "suggestedRename": {
          "type": "string",
          "description": "AI-suggested new title if task evolved/pivoted significantly"
        },
        "suggestedLabels": {
          "type": "array",
          "items": { "type": "string" },
          "description": "AI-suggested labels based on actual work done (e.g., auth, api, ui)"
        },
        "riskLevel": {
          "type": "string",
          "enum": ["low", "medium", "high"],
          "description": "Risk level: low=routine, medium=core logic, high=breaking/security/data"
        },
        "breakingChanges": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of breaking changes introduced"
        },
        "documentationNeeds": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Documentation that needs updating (e.g., README, API docs)"
        }
      }
    },

    "fileModification": {
      "type": "object",
      "description": "File modification details for review signal",
      "required": ["path", "changeType", "linesAdded", "linesRemoved"],
      "additionalProperties": false,
      "properties": {
        "path": {
          "type": "string",
          "description": "File path relative to project root"
        },
        "changeType": {
          "$ref": "#/definitions/changeType"
        },
        "linesAdded": {
          "type": "integer",
          "minimum": 0,
          "description": "Lines added in this file"
        },
        "linesRemoved": {
          "type": "integer",
          "minimum": 0,
          "description": "Lines removed from this file"
        },
        "description": {
          "type": "string",
          "maxLength": 500,
          "description": "Optional description of what changed"
        }
      }
    },
    "keyDecision": {
      "type": "object",
      "description": "Key decision made during implementation",
      "required": ["decision", "rationale"],
      "additionalProperties": false,
      "properties": {
        "decision": {
          "type": "string",
          "description": "The decision that was made"
        },
        "rationale": {
          "type": "string",
          "description": "Why this decision was made"
        }
      }
    },
    "commitInfo": {
      "type": "object",
      "description": "Commit information",
      "required": ["sha", "message"],
      "additionalProperties": false,
      "properties": {
        "sha": {
          "type": "string",
          "description": "Git commit SHA"
        },
        "message": {
          "type": "string",
          "description": "Commit message"
        }
      }
    },
    "reviewFocusItem": {
      "type": "object",
      "description": "Review focus item with optional links",
      "required": ["text"],
      "additionalProperties": false,
      "properties": {
        "text": {
          "type": "string",
          "description": "Description of the review focus area"
        },
        "filePath": {
          "type": "string",
          "description": "Optional file path related to this focus area"
        },
        "localhostRoute": {
          "type": "string",
          "description": "Optional localhost route to view this area (e.g., /dashboard, /login)"
        },
        "line": {
          "type": "integer",
          "minimum": 1,
          "description": "Optional line number in the file"
        }
      }
    },
    "questionOption": {
      "type": "object",
      "description": "Option for needs_input question",
      "required": ["id", "label", "description"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this option"
        },
        "label": {
          "type": "string",
          "description": "Display label"
        },
        "description": {
          "type": "string",
          "description": "Description of what this option means"
        },
        "recommended": {
          "type": "boolean",
          "description": "Whether this is the recommended option"
        },
        "tradeoffs": {
          "type": "string",
          "description": "Trade-offs of choosing this option"
        }
      }
    },
    "sessionStats": {
      "type": "object",
      "description": "Session statistics",
      "additionalProperties": false,
      "properties": {
        "duration": {
          "type": "integer",
          "minimum": 0,
          "description": "Minutes spent working on the task"
        },
        "tokensUsed": {
          "type": "integer",
          "minimum": 0,
          "description": "API tokens consumed during the session"
        },
        "filesModified": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of files modified"
        },
        "linesChanged": {
          "type": "integer",
          "minimum": 0,
          "description": "Total lines changed (added + removed)"
        },
        "commitsCreated": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of commits created"
        }
      }
    },
    "idleSessionSummary": {
      "type": "object",
      "description": "Session summary for idle signal",
      "additionalProperties": false,
      "properties": {
        "tasksCompleted": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Task IDs completed this session"
        },
        "totalDuration": {
          "type": "integer",
          "minimum": 0,
          "description": "Total minutes worked in this session"
        },
        "tokensUsed": {
          "type": "integer",
          "minimum": 0,
          "description": "Total tokens used in this session"
        },
        "filesModified": {
          "type": "integer",
          "minimum": 0,
          "description": "Total files modified in this session"
        }
      }
    },
    "suggestedNextTask": {
      "type": "object",
      "description": "Suggested next task for idle signal",
      "required": ["taskId", "title", "reason"],
      "additionalProperties": false,
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Task ID to work on next"
        },
        "title": {
          "type": "string",
          "description": "Task title"
        },
        "reason": {
          "type": "string",
          "description": "Why this task is recommended next"
        }
      }
    },

    "workingSignal": {
      "type": "object",
      "description": "Rich working signal emitted when agent starts work on a task",
      "required": ["taskId", "taskTitle"],
      "additionalProperties": false,
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Task ID (e.g., 'jat-abc')"
        },
        "taskTitle": {
          "type": "string",
          "description": "Task title"
        },
        "taskDescription": {
          "type": "string",
          "maxLength": 5000,
          "description": "Full description from Beads"
        },
        "taskPriority": {
          "type": "integer",
          "minimum": 0,
          "maximum": 4,
          "description": "Priority level: 0-4"
        },
        "taskType": {
          "type": "string",
          "enum": ["feature", "bug", "task", "chore", "epic"],
          "description": "Task type"
        },
        "approach": {
          "type": "string",
          "maxLength": 2000,
          "description": "How the agent plans to implement"
        },
        "expectedFiles": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Glob patterns of files expected to be modified"
        },
        "estimatedScope": {
          "$ref": "#/definitions/estimatedScope"
        },
        "baselineCommit": {
          "type": "string",
          "description": "Git SHA where work starts"
        },
        "baselineBranch": {
          "type": "string",
          "description": "Current git branch"
        },
        "dependencies": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Task IDs this task depends on"
        },
        "blockers": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Known issues or blockers"
        }
      }
    },
    "reviewSignal": {
      "type": "object",
      "description": "Rich review signal emitted when agent finishes coding",
      "required": ["taskId", "taskTitle", "summary"],
      "additionalProperties": false,
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Task ID that was worked on"
        },
        "taskTitle": {
          "type": "string",
          "description": "Task title"
        },
        "summary": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Bullet points of what was accomplished"
        },
        "approach": {
          "type": "string",
          "maxLength": 2000,
          "description": "How the implementation was done"
        },
        "keyDecisions": {
          "type": "array",
          "items": { "$ref": "#/definitions/keyDecision" },
          "description": "Architectural choices made during implementation"
        },
        "filesModified": {
          "type": "array",
          "items": { "$ref": "#/definitions/fileModification" },
          "description": "Files modified with details"
        },
        "totalLinesAdded": {
          "type": "integer",
          "minimum": 0,
          "description": "Total lines added across all files"
        },
        "totalLinesRemoved": {
          "type": "integer",
          "minimum": 0,
          "description": "Total lines removed across all files"
        },
        "testsStatus": {
          "type": "string",
          "enum": ["passing", "failing", "none", "skipped"],
          "description": "Test status"
        },
        "testsRun": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of tests run"
        },
        "testsPassed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of tests passed"
        },
        "buildStatus": {
          "type": "string",
          "enum": ["clean", "warnings", "errors"],
          "description": "Build status"
        },
        "buildWarnings": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Build warning messages"
        },
        "reviewFocus": {
          "type": "array",
          "items": {
            "oneOf": [
              { "type": "string" },
              { "$ref": "#/definitions/reviewFocusItem" }
            ]
          },
          "description": "Areas to focus review on - can be strings or objects with links"
        },
        "knownLimitations": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Known limitations or edge cases not handled"
        },
        "commits": {
          "type": "array",
          "items": { "$ref": "#/definitions/commitInfo" },
          "description": "Commits made during this work"
        }
      }
    },
    "needsInputSignal": {
      "type": "object",
      "description": "Rich needs_input signal when agent is blocked",
      "required": ["taskId", "taskTitle", "question", "questionType", "context", "impact", "blocking"],
      "additionalProperties": false,
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Task ID being worked on"
        },
        "taskTitle": {
          "type": "string",
          "description": "Task title"
        },
        "question": {
          "type": "string",
          "description": "The actual question being asked"
        },
        "questionType": {
          "$ref": "#/definitions/questionType"
        },
        "context": {
          "type": "string",
          "description": "Why this question arose"
        },
        "relevantCode": {
          "type": "string",
          "maxLength": 5000,
          "description": "Relevant code snippet"
        },
        "relevantFiles": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files related to the question"
        },
        "options": {
          "type": "array",
          "items": { "$ref": "#/definitions/questionOption" },
          "description": "Available options to choose from"
        },
        "impact": {
          "type": "string",
          "description": "What happens based on the answer"
        },
        "blocking": {
          "type": "array",
          "items": { "type": "string" },
          "description": "What is blocked until this is answered"
        },
        "timeoutAction": {
          "type": "string",
          "description": "What agent will do if no response"
        },
        "timeoutMinutes": {
          "type": "integer",
          "minimum": 1,
          "description": "Minutes until timeout action is taken"
        }
      }
    },
    "completingSignal": {
      "type": "object",
      "description": "Rich completing signal during completion steps",
      "required": ["taskId", "taskTitle", "currentStep", "stepsCompleted", "stepsRemaining", "progress", "stepDescription", "stepStartedAt"],
      "additionalProperties": false,
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Task ID being completed"
        },
        "taskTitle": {
          "type": "string",
          "description": "Task title"
        },
        "currentStep": {
          "$ref": "#/definitions/completionStep"
        },
        "stepsCompleted": {
          "type": "array",
          "items": { "$ref": "#/definitions/completionStep" },
          "description": "Steps that have been completed"
        },
        "stepsRemaining": {
          "type": "array",
          "items": { "$ref": "#/definitions/completionStep" },
          "description": "Steps remaining to be done"
        },
        "progress": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Overall progress percentage"
        },
        "stepDescription": {
          "type": "string",
          "description": "Human-readable description of current step"
        },
        "stepStartedAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO timestamp when current step started"
        }
      }
    },
    "idleSignal": {
      "type": "object",
      "description": "Enhanced idle signal with session summary",
      "required": ["readyForWork"],
      "additionalProperties": false,
      "properties": {
        "sessionSummary": {
          "$ref": "#/definitions/idleSessionSummary"
        },
        "suggestedNextTask": {
          "$ref": "#/definitions/suggestedNextTask"
        },
        "readyForWork": {
          "type": "boolean",
          "description": "Whether agent can accept new work"
        },
        "blockedReason": {
          "type": "string",
          "description": "If not ready, why"
        }
      }
    },
    "startingSignal": {
      "type": "object",
      "description": "Enhanced starting signal with agent capabilities",
      "required": ["agentName", "project", "sessionId", "model", "gitBranch", "gitStatus"],
      "additionalProperties": false,
      "properties": {
        "agentName": {
          "type": "string",
          "description": "Agent name for this session"
        },
        "project": {
          "type": "string",
          "description": "Project being worked on"
        },
        "sessionId": {
          "type": "string",
          "description": "Claude Code session ID"
        },
        "taskId": {
          "type": "string",
          "description": "Task ID if starting on a specific task"
        },
        "taskTitle": {
          "type": "string",
          "description": "Task title if starting on a specific task"
        },
        "model": {
          "type": "string",
          "description": "Model being used"
        },
        "tools": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Available tools in this session"
        },
        "gitBranch": {
          "type": "string",
          "description": "Current git branch"
        },
        "gitStatus": {
          "$ref": "#/definitions/gitStatus"
        },
        "uncommittedFiles": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of uncommitted files"
        }
      }
    },
    "compactingSignal": {
      "type": "object",
      "description": "Compacting signal when context is being summarized",
      "required": ["reason", "contextSizeBefore", "estimatedAfter", "preserving"],
      "additionalProperties": false,
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Task ID if currently working on a task"
        },
        "reason": {
          "type": "string",
          "description": "Why compaction is happening"
        },
        "contextSizeBefore": {
          "type": "integer",
          "minimum": 0,
          "description": "Token count before compaction"
        },
        "estimatedAfter": {
          "type": "integer",
          "minimum": 0,
          "description": "Expected token count after compaction"
        },
        "preserving": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Key context items being preserved"
        }
      }
    },
    "questionSignalQuestionType": {
      "type": "string",
      "enum": ["choice", "confirm", "input"],
      "description": "Type of question: choice (select from options), confirm (yes/no), input (free text)"
    },
    "questionSignalOption": {
      "type": "object",
      "description": "Single option for a question",
      "required": ["label", "value"],
      "additionalProperties": false,
      "properties": {
        "label": {
          "type": "string",
          "description": "Display label shown to user"
        },
        "value": {
          "type": "string",
          "description": "Value returned when this option is selected"
        },
        "description": {
          "type": "string",
          "description": "Optional description explaining what this option means"
        }
      }
    },
    "questionSignal": {
      "type": "object",
      "description": "Question signal emitted when agent needs user input. Provides structured data for rich question UIs.",
      "required": ["question", "questionType"],
      "additionalProperties": false,
      "properties": {
        "question": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2000,
          "description": "The question text being asked"
        },
        "questionType": {
          "$ref": "#/definitions/questionSignalQuestionType"
        },
        "options": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/questionSignalOption"
          },
          "minItems": 1,
          "maxItems": 10,
          "description": "Available options for choice-type questions"
        },
        "timeout": {
          "type": "integer",
          "minimum": 1,
          "maximum": 86400,
          "description": "Optional timeout in seconds after which agent may take default action"
        }
      }
    }
  }
}
