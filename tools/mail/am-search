#!/usr/bin/env bash
# Search messages by keyword or thread
# Usage: am-search "query" [--thread bd-123] [--limit 10] [--json]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/am-lib.sh"

# Parse arguments
QUERY=""
THREAD_FILTER=""
LIMIT="20"
PROJECT="$PROJECT_KEY"
JSON_OUTPUT=false

show_help() {
    cat <<EOF
Usage: am-search "query" [options]

Search messages using full-text search on subject and body.

Arguments:
  QUERY               Search query (required)

Options:
  --thread ID         Filter by thread ID (e.g., bd-123)
  --limit N           Limit number of results (default: 20)
  --project PATH      Project path (default: current directory)
  --json              Output as JSON
  --help, -h          Show this help

Examples:
  am-search "authentication"
  am-search "bug" --thread bd-123
  am-search "urgent" --limit 5 --json

Database: $AGENT_MAIL_DB
EOF
}

# First positional arg is query
if [[ $# -ge 1 ]] && [[ ! "$1" =~ ^-- ]]; then
    QUERY="$1"
    shift
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        --thread)
            THREAD_FILTER="$2"
            shift 2
            ;;
        --limit)
            LIMIT="$2"
            shift 2
            ;;
        --project)
            PROJECT="$2"
            shift 2
            ;;
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            am_error "Unknown option: $1"
            ;;
    esac
done

# Validate required arguments
if [[ -z "$QUERY" ]]; then
    am_error "Search query is required"
fi

# Get or create project
PROJECT_ID=$(am_get_project "$AGENT_MAIL_DB" "$PROJECT")

# Build search query
# Use FTS5 virtual table for full-text search
FTS_QUERY="${QUERY//\'/\'\'}"  # Escape single quotes

SEARCH_SQL="
SELECT
    m.id,
    m.subject,
    m.body_md,
    m.thread_id,
    m.importance,
    m.created_ts,
    a.name as sender_name
FROM messages_fts
JOIN messages m ON messages_fts.rowid = m.id
JOIN agents a ON m.sender_id = a.id
WHERE messages_fts MATCH '$FTS_QUERY'
  AND m.project_id = $PROJECT_ID"

if [[ -n "$THREAD_FILTER" ]]; then
    THREAD_ESC="${THREAD_FILTER//\'/\'\'}"
    SEARCH_SQL="$SEARCH_SQL AND m.thread_id = '$THREAD_ESC'"
fi

SEARCH_SQL="$SEARCH_SQL
ORDER BY m.created_ts DESC
LIMIT $LIMIT"

# Execute search
RESULTS=$(sqlite3 -json "$AGENT_MAIL_DB" "$SEARCH_SQL")

# Display results
if [[ "$JSON_OUTPUT" == "true" ]]; then
    echo "$RESULTS" | am_format_json
else
    RESULT_COUNT=$(echo "$RESULTS" | jq '. | length')

    if [[ "$RESULT_COUNT" == "0" ]]; then
        echo "No messages found matching: $QUERY"
        exit 0
    fi

    echo "Found $RESULT_COUNT message(s) matching: $QUERY"
    echo ""

    echo "$RESULTS" | jq -r '.[] | "───────────────────────────────────────
ID: \(.id) | \(.importance | ascii_upcase)
From: \(.sender_name)
Subject: \(.subject)
\(if .thread_id then "Thread: \(.thread_id)\n" else "" end)Sent: \(.created_ts)

\(.body_md)
"'
fi
