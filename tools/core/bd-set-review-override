#!/bin/bash

# bd-set-review-override - Set task-level review override in Beads
#
# This stores the override directly on the task (in the notes field),
# not in the centralized review-rules.json file.
#
# Usage:
#   bd-set-review-override TASK_ID always_review [REASON]
#   bd-set-review-override TASK_ID always_auto [REASON]
#   bd-set-review-override TASK_ID --clear
#   bd-set-review-override TASK_ID --show
#
# Examples:
#   bd-set-review-override jat-abc always_review "Security sensitive"
#   bd-set-review-override jat-xyz always_auto "Low risk cleanup"
#   bd-set-review-override jat-abc --clear
#   bd-set-review-override jat-abc --show
#
# Storage:
#   The override is stored in the task's notes field as:
#   [REVIEW_OVERRIDE:always_review] or [REVIEW_OVERRIDE:always_auto]
#
# Priority:
#   Task-level overrides take precedence over:
#   1. JSON file overrides (.beads/review-rules.json)
#   2. Type-specific rules (review_rules.<type>.max_auto)
#   3. Default action (review_rules.default_action)

set -e

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Parse arguments
TASK_ID="$1"
ACTION="$2"
REASON="$3"

# Help
if [[ "$TASK_ID" == "--help" ]] || [[ "$TASK_ID" == "-h" ]] || [[ -z "$TASK_ID" ]]; then
    echo "bd-set-review-override - Set task-level review override"
    echo ""
    echo "Usage:"
    echo "  bd-set-review-override TASK_ID always_review [REASON]"
    echo "  bd-set-review-override TASK_ID always_auto [REASON]"
    echo "  bd-set-review-override TASK_ID --clear"
    echo "  bd-set-review-override TASK_ID --show"
    echo ""
    echo "Arguments:"
    echo "  TASK_ID        The task ID to set override for"
    echo "  always_review  Task will always require human review"
    echo "  always_auto    Task will always auto-proceed on completion"
    echo "  --clear        Remove the override from the task"
    echo "  --show         Show current override for the task"
    echo ""
    echo "Examples:"
    echo "  bd-set-review-override jat-abc always_review \"Security sensitive\""
    echo "  bd-set-review-override jat-xyz always_auto"
    echo "  bd-set-review-override jat-abc --clear"
    echo ""
    echo "The override is stored in the task's notes field and takes"
    echo "precedence over type rules and JSON file overrides."
    exit 0
fi

# Verify task exists
if ! bd show "$TASK_ID" --json >/dev/null 2>&1; then
    echo -e "${RED}Error: Task not found: $TASK_ID${NC}" >&2
    exit 1
fi

# Get current task data
task_json=$(bd show "$TASK_ID" --json)
task_title=$(echo "$task_json" | jq -r '.[0].title // "Unknown"')
current_notes=$(echo "$task_json" | jq -r '.[0].notes // ""')

# Extract current override if any
current_override=$(echo "$current_notes" | grep -oP '\[REVIEW_OVERRIDE:\K[^\]]+' || echo "")

# Handle --show
if [[ "$ACTION" == "--show" ]] || [[ "$ACTION" == "-s" ]]; then
    echo ""
    echo -e "${BOLD}Review Override for $TASK_ID${NC}"
    echo -e "${DIM}$task_title${NC}"
    echo ""
    if [[ -n "$current_override" ]]; then
        if [[ "$current_override" == "always_review" ]]; then
            echo -e "  Override: ${YELLOW}always_review${NC}"
            echo "  This task will require human review on completion"
        else
            echo -e "  Override: ${GREEN}always_auto${NC}"
            echo "  This task will auto-proceed on completion"
        fi
    else
        echo -e "  ${DIM}No task-level override set${NC}"
        echo "  Task uses type rules or JSON file settings"
    fi
    echo ""
    exit 0
fi

# Handle --clear
if [[ "$ACTION" == "--clear" ]] || [[ "$ACTION" == "-c" ]]; then
    if [[ -z "$current_override" ]]; then
        echo -e "${YELLOW}No override to clear for $TASK_ID${NC}"
        exit 0
    fi

    # Remove the override marker from notes
    new_notes=$(echo "$current_notes" | sed 's/\[REVIEW_OVERRIDE:[^\]]*\]//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    # Update the task
    if [[ -z "$new_notes" ]]; then
        bd update "$TASK_ID" --notes "" >/dev/null 2>&1
    else
        bd update "$TASK_ID" --notes "$new_notes" >/dev/null 2>&1
    fi

    echo -e "${GREEN}✓ Cleared override for $TASK_ID${NC}"
    exit 0
fi

# Validate action
if [[ "$ACTION" != "always_review" ]] && [[ "$ACTION" != "always_auto" ]]; then
    echo -e "${RED}Error: Action must be 'always_review', 'always_auto', '--clear', or '--show'${NC}" >&2
    echo "Use --help for usage information" >&2
    exit 1
fi

# Build the new override marker
override_marker="[REVIEW_OVERRIDE:$ACTION]"

# Add reason if provided
if [[ -n "$REASON" ]]; then
    override_marker="[REVIEW_OVERRIDE:$ACTION] ($REASON)"
fi

# Update notes - remove old override if exists, add new one
if [[ -n "$current_override" ]]; then
    # Replace existing override
    new_notes=$(echo "$current_notes" | sed 's/\[REVIEW_OVERRIDE:[^\]]*\]\( ([^)]*)\)\?//')
    new_notes=$(echo "$new_notes" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    if [[ -n "$new_notes" ]]; then
        new_notes="$new_notes $override_marker"
    else
        new_notes="$override_marker"
    fi
else
    # Add new override
    if [[ -n "$current_notes" ]]; then
        new_notes="$current_notes $override_marker"
    else
        new_notes="$override_marker"
    fi
fi

# Update the task
bd update "$TASK_ID" --notes "$new_notes" >/dev/null 2>&1

echo -e "${GREEN}✓ Set override for $TASK_ID: $ACTION${NC}"
if [[ -n "$REASON" ]]; then
    echo -e "  ${DIM}Reason: $REASON${NC}"
fi

# Show what this means
echo ""
if [[ "$ACTION" == "always_review" ]]; then
    echo -e "  ${YELLOW}→${NC} This task will require human review on completion"
else
    echo -e "  ${GREEN}→${NC} This task will auto-proceed on completion"
fi
