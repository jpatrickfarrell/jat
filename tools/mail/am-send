#!/usr/bin/env bash
# Send a message to other agents
# Usage: am-send "Subject" "Body" --from Agent1 --to Agent2[,Agent3] [--cc Agent4] [--thread id] [--importance high] [--ack]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/am-lib.sh"

# Parse arguments
SUBJECT=""
BODY=""
FROM_AGENT=""
TO_AGENTS=""
CC_AGENTS=""
THREAD_ID=""
IMPORTANCE="normal"
ACK_REQUIRED=0
PROJECT="$PROJECT_KEY"
JSON_OUTPUT=false
ACTIVE_WINDOW=60  # Default: 60 minutes for @active mention

show_help() {
    cat <<EOF
Usage: am-send "Subject" "Body" [options]

Send a message to other agents in Agent Mail.

Arguments:
  SUBJECT             Message subject (required)
  BODY                Message body in markdown (required)

Options:
  --from AGENT        Sending agent name (required)
  --to AGENTS         Comma-separated list of recipient agent names (required)
                      Supports broadcast mentions for multi-agent messaging:
                        @active, @recent, @all, @project:name
                      Can mix mentions with specific names: "@active,Agent1,Agent2"
  --cc AGENTS         Comma-separated list of CC recipients (optional)
  --thread ID         Thread identifier (e.g., bd-123) (optional)
  --importance LEVEL  Message importance: normal | high | urgent (default: normal)
  --ack               Require acknowledgment (default: false)
  --active-window N   Time window in minutes for @active (default: 60)
                      Only affects @active mention expansion
  --project PATH      Project path (default: current directory)
  --json              Output as JSON
  --help, -h          Show this help

Examples:
  # Basic messaging
  am-send "Hello" "Testing" --from Agent1 --to Agent2
  am-send "[bd-123] Start work" "Beginning task..." --from Builder --to Team --thread bd-123 --ack
  am-send "Update" "Progress report" --from Agent1 --to Agent2,Agent3 --cc Manager --importance high

  # Broadcast examples
  am-send "Announcement" "Server maintenance tonight" --from Admin --to @active --importance high
  am-send "Quick sync" "Need immediate help" --from Dev --to @active --active-window 15 --importance urgent
  am-send "Critical Alert" "System down" --from Monitor --to @all --importance urgent
  am-send "Project Update" "Sprint completed" --from Lead --to @project:jat --importance high
  am-send "Team sync" "Daily standup notes" --from Dev --to @recent --importance normal

  # Mixed usage (broadcast + specific agents)
  am-send "Code review needed" "PR ready" --from Dev --to @active,SeniorDev --importance high
  am-send "Deploy notice" "Pushing to prod" --from DevOps --to @project:backend,QA-Team --importance urgent

Broadcast Mentions:
  Use these special mentions in --to AGENTS to send messages to multiple agents.
  All mentions automatically expand to comma-separated agent lists.

  @active             Agents active in last 60 minutes (configurable with --active-window)
                      Default window: 60 minutes
                      Custom window: --active-window 15 (for 15 minutes)
                      Output: "✓ Expanded @active → N agent(s) (last X min): Agent1,Agent2..."

  @recent             Agents active in last 24 hours
                      Fixed 24-hour window (not configurable)
                      Output: "✓ Expanded @recent → N agent(s): Agent1,Agent2..."

  @all                ALL registered agents (includes offline/inactive agents)
                      Use with caution for very large agent populations
                      Output: "✓ Broadcasting to all agents: N" or "⚠️ Broadcasting to all agents: N (large broadcast!)"

  @project:name       All agents in a specific project (by project slug)
                      Example: @project:jat, @project:chimaro
                      Output: "✓ Expanded @project:name → N agent(s): Agent1,Agent2..."
                      Error: Shows available projects if project not found

Database: $AGENT_MAIL_DB
EOF
}

# First two positional args are subject and body
if [[ $# -ge 2 ]] && [[ ! "$1" =~ ^-- ]]; then
    SUBJECT="$1"
    shift
    BODY="$1"
    shift
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        --from)
            FROM_AGENT="$2"
            shift 2
            ;;
        --to)
            TO_AGENTS="$2"
            shift 2
            ;;
        --cc)
            CC_AGENTS="$2"
            shift 2
            ;;
        --thread)
            THREAD_ID="$2"
            shift 2
            ;;
        --importance)
            IMPORTANCE="$2"
            shift 2
            ;;
        --ack)
            ACK_REQUIRED=1
            shift
            ;;
        --project)
            PROJECT="$2"
            shift 2
            ;;
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --active-window)
            ACTIVE_WINDOW="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            am_error "Unknown option: $1"
            ;;
    esac
done

# Validate required arguments
if [[ -z "$SUBJECT" ]]; then
    am_error "Subject is required"
fi

if [[ -z "$BODY" ]]; then
    am_error "Body is required"
fi

if [[ -z "$FROM_AGENT" ]]; then
    am_error "--from agent is required"
fi

if [[ -z "$TO_AGENTS" ]]; then
    am_error "--to agents is required"
fi

# Validate active-window (must be positive integer)
if ! [[ "$ACTIVE_WINDOW" =~ ^[0-9]+$ ]] || [[ "$ACTIVE_WINDOW" -le 0 ]]; then
    am_error "--active-window must be a positive integer (minutes)"
fi

# Expand @all mention to ALL registered agents (even offline)
if [[ "$TO_AGENTS" == *"@all"* ]]; then
    ALL_AGENTS=$(sqlite3 "$AGENT_MAIL_DB" "SELECT name FROM agents ORDER BY name;" | tr '\n' ',' | sed 's/,$//')

    if [[ -z "$ALL_AGENTS" ]]; then
        am_error "No agents found in database. Cannot expand @all mention."
    fi

    # Replace @all with expanded list
    TO_AGENTS="${TO_AGENTS//@all/$ALL_AGENTS}"

    # Count agents for display
    ALL_COUNT=$(echo "$ALL_AGENTS" | tr ',' '\n' | wc -l)

    # Show expansion with warning if large number
    if [[ "$ALL_COUNT" -gt 50 ]]; then
        echo "⚠️  Broadcasting to all agents: $ALL_COUNT (large broadcast!)"
    else
        echo "✓ Broadcasting to all agents: $ALL_COUNT"
    fi
fi

# Expand @active mention to agents active in last N minutes (configurable via --active-window)
if [[ "$TO_AGENTS" == *"@active"* ]]; then
    ACTIVE_AGENTS=$(sqlite3 "$AGENT_MAIL_DB" "SELECT name FROM agents WHERE datetime(last_active_ts) > datetime('now', '-$ACTIVE_WINDOW minutes') ORDER BY name;" | tr '\n' ',' | sed 's/,$//')

    if [[ -z "$ACTIVE_AGENTS" ]]; then
        am_error "No active agents found (last $ACTIVE_WINDOW minutes). Cannot expand @active mention."
    fi

    # Replace @active with expanded list
    TO_AGENTS="${TO_AGENTS//@active/$ACTIVE_AGENTS}"

    # Count agents for display
    ACTIVE_COUNT=$(echo "$ACTIVE_AGENTS" | tr ',' '\n' | wc -l)

    # Show expansion
    echo "✓ Expanded @active → $ACTIVE_COUNT agent(s) (last $ACTIVE_WINDOW min): $ACTIVE_AGENTS"
fi

# Expand @recent mention to agents active in last 24 hours
if [[ "$TO_AGENTS" == *"@recent"* ]]; then
    RECENT_AGENTS=$(sqlite3 "$AGENT_MAIL_DB" "SELECT name FROM agents WHERE datetime(last_active_ts) > datetime('now', '-24 hours') ORDER BY name;" | tr '\n' ',' | sed 's/,$//')

    if [[ -z "$RECENT_AGENTS" ]]; then
        am_error "No recent agents found (last 24 hours). Cannot expand @recent mention."
    fi

    # Replace @recent with expanded list
    TO_AGENTS="${TO_AGENTS//@recent/$RECENT_AGENTS}"

    # Count agents for display
    RECENT_COUNT=$(echo "$RECENT_AGENTS" | tr ',' '\n' | wc -l)

    # Show expansion
    echo "✓ Expanded @recent → $RECENT_COUNT agent(s): $RECENT_AGENTS"
fi

# Expand @project:name mention to all agents in specified project
if [[ "$TO_AGENTS" =~ @project:([a-zA-Z0-9_-]+) ]]; then
    PROJECT_NAME="${BASH_REMATCH[1]}"

    # Query agents in this project using slug
    PROJECT_AGENTS=$(sqlite3 "$AGENT_MAIL_DB" "SELECT a.name FROM agents a JOIN projects p ON a.project_id = p.id WHERE p.slug = '$PROJECT_NAME' ORDER BY a.name;" | tr '\n' ',' | sed 's/,$//')

    if [[ -z "$PROJECT_AGENTS" ]]; then
        available_projects=$(sqlite3 "$AGENT_MAIL_DB" "SELECT slug FROM projects ORDER BY slug;" | tr '\n' ', ' | sed 's/, $//')
        echo "✗ Error: No agents found in project '$PROJECT_NAME'. Cannot expand @project:$PROJECT_NAME mention." >&2
        echo "Available projects: $available_projects" >&2
        exit 1
    fi

    # Replace @project:name with expanded list
    TO_AGENTS="${TO_AGENTS//@project:$PROJECT_NAME/$PROJECT_AGENTS}"

    # Count agents for display
    PROJECT_COUNT=$(echo "$PROJECT_AGENTS" | tr ',' '\n' | wc -l)

    # Show expansion
    echo "✓ Expanded @project:$PROJECT_NAME → $PROJECT_COUNT agent(s): $PROJECT_AGENTS"
fi

# Validate importance level
if [[ ! "$IMPORTANCE" =~ ^(normal|high|urgent)$ ]]; then
    am_error "Importance must be: normal, high, or urgent"
fi

# Get or create project
PROJECT_ID=$(am_get_project "$AGENT_MAIL_DB" "$PROJECT")

# Validate from_agent exists
SENDER_ID=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM agents WHERE project_id = $PROJECT_ID AND name = '$FROM_AGENT';")
if [[ -z "$SENDER_ID" ]]; then
    am_error "From agent '$FROM_AGENT' not found. Run: am-register --name $FROM_AGENT"
fi

# Update sender's last_active
am_touch_agent "$AGENT_MAIL_DB" "$SENDER_ID"

# Escape single quotes in subject and body for SQL
SUBJECT_ESC="${SUBJECT//\'/\'\'}"
BODY_ESC="${BODY//\'/\'\'}"
THREAD_ID_ESC="${THREAD_ID//\'/\'\'}"

# Create message and get ID in same connection
MESSAGE_ID=$(sqlite3 "$AGENT_MAIL_DB" <<SQL
INSERT INTO messages (project_id, sender_id, thread_id, subject, body_md, importance, ack_required)
VALUES ($PROJECT_ID, $SENDER_ID, $([ -n "$THREAD_ID_ESC" ] && echo "'$THREAD_ID_ESC'" || echo "NULL"), '$SUBJECT_ESC', '$BODY_ESC', '$IMPORTANCE', $ACK_REQUIRED);
SELECT last_insert_rowid();
SQL
)

# Add TO recipients
IFS=',' read -ra TO_ARRAY <<< "$TO_AGENTS"
for agent_name in "${TO_ARRAY[@]}"; do
    agent_name=$(echo "$agent_name" | xargs)  # trim whitespace
    AGENT_ID=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM agents WHERE project_id = $PROJECT_ID AND name = '$agent_name';")
    if [[ -z "$AGENT_ID" ]]; then
        am_error "Recipient agent '$agent_name' not found. Run: am-register --name $agent_name"
    fi
    sqlite3 "$AGENT_MAIL_DB" "INSERT INTO message_recipients (message_id, agent_id, kind) VALUES ($MESSAGE_ID, $AGENT_ID, 'to');"
done

# Add CC recipients if provided
if [[ -n "$CC_AGENTS" ]]; then
    IFS=',' read -ra CC_ARRAY <<< "$CC_AGENTS"
    for agent_name in "${CC_ARRAY[@]}"; do
        agent_name=$(echo "$agent_name" | xargs)  # trim whitespace
        AGENT_ID=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM agents WHERE project_id = $PROJECT_ID AND name = '$agent_name';")
        if [[ -z "$AGENT_ID" ]]; then
            am_error "CC agent '$agent_name' not found. Run: am-register --name $agent_name"
        fi
        sqlite3 "$AGENT_MAIL_DB" "INSERT INTO message_recipients (message_id, agent_id, kind) VALUES ($MESSAGE_ID, $AGENT_ID, 'cc');"
    done
fi

# Fetch and display message details
MESSAGE=$(sqlite3 -json "$AGENT_MAIL_DB" <<SQL
SELECT
    m.id,
    m.subject,
    m.thread_id,
    m.importance,
    m.ack_required,
    m.created_ts,
    a.name as sender_name
FROM messages m
JOIN agents a ON m.sender_id = a.id
WHERE m.id = $MESSAGE_ID;
SQL
)

if [[ "$JSON_OUTPUT" == "true" ]]; then
    echo "$MESSAGE" | am_format_json
else
    SUBJECT_VAL=$(echo "$MESSAGE" | jq -r '.[0].subject')
    THREAD_VAL=$(echo "$MESSAGE" | jq -r '.[0].thread_id // ""')
    SENDER_VAL=$(echo "$MESSAGE" | jq -r '.[0].sender_name')
    CREATED_VAL=$(echo "$MESSAGE" | jq -r '.[0].created_ts')

    am_success "Message sent (ID: $MESSAGE_ID)"
    echo "  From: $SENDER_VAL"
    echo "  To: $TO_AGENTS"
    [[ -n "$CC_AGENTS" ]] && echo "  CC: $CC_AGENTS"
    echo "  Subject: $SUBJECT_VAL"
    [[ -n "$THREAD_VAL" ]] && echo "  Thread: $THREAD_VAL"
    echo "  Importance: $IMPORTANCE"
    [[ "$ACK_REQUIRED" == "1" ]] && echo "  Acknowledgment: Required"
    echo "  Sent: $CREATED_VAL"
fi
