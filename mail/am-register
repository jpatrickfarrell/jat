#!/usr/bin/env bash
# Register or resume agent identity with Agent Mail
# Usage: am-register [--name AgentName] [--program claude-code] [--model sonnet-4.5] [--task "Description"]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/am-lib.sh"

# Parse arguments
NAME=""
PROGRAM="claude-code"
MODEL="sonnet-4.5"
TASK=""
PROJECT="$PROJECT_KEY"
JSON_OUTPUT=false

show_help() {
    cat <<EOF
Usage: am-register [options]

Register or resume an agent identity in Agent Mail.

IMPORTANT: Agent names are globally unique across all projects.
If an agent name already exists, this command will resume that agent
(updating last_active timestamp) instead of creating a duplicate.

Options:
  --name NAME         Agent name (adjective+noun, omit to auto-generate)
  --program PROGRAM   Program name (default: claude-code)
  --model MODEL       Model name (default: sonnet-4.5)
  --task TASK         Task description (default: "")
  --project PATH      Project path (default: current directory)
  --json              Output as JSON
  --help, -h          Show this help

Examples:
  am-register
  am-register --name BlueLake
  am-register --program cursor --model gpt-4 --task "Bug fixes"
  am-register --json

Database: $AGENT_MAIL_DB
EOF
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        --name)
            NAME="$2"
            shift 2
            ;;
        --program)
            PROGRAM="$2"
            shift 2
            ;;
        --model)
            MODEL="$2"
            shift 2
            ;;
        --task)
            TASK="$2"
            shift 2
            ;;
        --project)
            PROJECT="$2"
            shift 2
            ;;
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            am_error "Unknown option: $1"
            ;;
    esac
done

# Get or create project
PROJECT_ID=$(am_get_project "$AGENT_MAIL_DB" "$PROJECT")

# Generate name if not provided
if [[ -z "$NAME" ]]; then
    # Try to find an unused name (check globally, not per-project)
    for attempt in {1..10}; do
        NAME=$(am_generate_name)
        existing=$(sqlite3 "$AGENT_MAIL_DB" "SELECT COUNT(*) FROM agents WHERE name = '$NAME';")
        if [[ "$existing" == "0" ]]; then
            break
        fi
    done
fi

# Check if agent already exists (globally across all projects)
AGENT_ID=$(sqlite3 "$AGENT_MAIL_DB" "SELECT id FROM agents WHERE name = '$NAME';")
AGENT_EXISTS=false

if [[ -n "$AGENT_ID" ]]; then
    # Agent exists globally - resume by updating last_active
    AGENT_EXISTS=true
    sqlite3 "$AGENT_MAIL_DB" <<SQL
UPDATE agents
SET program = '$PROGRAM',
    model = '$MODEL',
    task_description = '$TASK',
    last_active_ts = datetime('now')
WHERE id = $AGENT_ID;
SQL
else
    # Create new agent (name is globally unique)
    AGENT_ID=$(sqlite3 "$AGENT_MAIL_DB" <<SQL
INSERT INTO agents (project_id, name, program, model, task_description)
VALUES ($PROJECT_ID, '$NAME', '$PROGRAM', '$MODEL', '$TASK');
SELECT last_insert_rowid();
SQL
    )
fi

# Fetch and display agent details
AGENT=$(sqlite3 -json "$AGENT_MAIL_DB" <<SQL
SELECT
    id,
    name,
    program,
    model,
    task_description,
    inception_ts,
    last_active_ts
FROM agents
WHERE id = $AGENT_ID;
SQL
)

# Generate avatar if missing (fire-and-forget, don't fail registration)
AVATARS_DIR="${SCRIPT_DIR}/../avatars"
AVATAR_PATH="${AVATARS_DIR}/${NAME}.svg"
AVATAR_GENERATE="${SCRIPT_DIR}/../media/avatar-generate"

if [[ ! -f "$AVATAR_PATH" && -x "$AVATAR_GENERATE" ]]; then
    # Only attempt if ANTHROPIC_API_KEY is set
    if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
        "$AVATAR_GENERATE" "$NAME" >/dev/null 2>&1 || true
    fi
fi

if [[ "$JSON_OUTPUT" == "true" ]]; then
    echo "$AGENT" | am_format_json
else
    NAME_VAL=$(echo "$AGENT" | jq -r '.[0].name')
    PROGRAM_VAL=$(echo "$AGENT" | jq -r '.[0].program')
    MODEL_VAL=$(echo "$AGENT" | jq -r '.[0].model')
    TASK_VAL=$(echo "$AGENT" | jq -r '.[0].task_description')
    LAST_ACTIVE=$(echo "$AGENT" | jq -r '.[0].last_active_ts')

    if [[ "$AGENT_EXISTS" == "true" ]]; then
        am_success "✅ Resuming existing agent: $NAME_VAL"
    else
        am_success "✨ Created new agent: $NAME_VAL"
    fi
    echo "  Program: $PROGRAM_VAL"
    echo "  Model: $MODEL_VAL"
    echo "  Task: ${TASK_VAL:-(none)}"
    echo "  Last active: $LAST_ACTIVE"
    echo "  Database: $AGENT_MAIL_DB"

    # Show avatar status
    if [[ -f "$AVATAR_PATH" ]]; then
        echo "  Avatar: $AVATAR_PATH"
    fi
fi
