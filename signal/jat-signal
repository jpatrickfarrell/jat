#!/usr/bin/env bash
#
# jat-signal - Emit structured signals for dashboard consumption
#
# Usage (State Signals - require JSON payload):
#   jat-signal working '{"taskId":"jat-abc","taskTitle":"..."}'
#   jat-signal review '{"taskId":"jat-abc","summary":["..."]}'
#   jat-signal needs_input '{"taskId":"jat-abc","question":"...","questionType":"choice"}'
#   jat-signal idle '{"readyForWork":true}'
#   jat-signal completing '{"taskId":"jat-abc","currentStep":"committing"}'
#   jat-signal completed '{"taskId":"jat-abc","outcome":"success"}'
#   jat-signal starting '{"agentName":"...","project":"..."}'
#   jat-signal compacting '{"reason":"...","contextSizeBefore":180000}'
#   jat-signal auto_proceed '{"taskId":"jat-abc"}'
#
# Usage (Data Signals - always JSON):
#   jat-signal tasks '[{...}]'                      # Suggest follow-up tasks
#   jat-signal action '{"title":"...","desc":"..."}' # Request human action
#   jat-signal complete '{"suggestedTasks":[...]}'  # Full completion bundle
#
# Options:
#   --no-validate    Skip JSON schema validation
#   --strict         Fail on validation errors (default: warn)
#
# All signals emit: [JAT-SIGNAL:<TYPE>] <json-payload>
# The PostToolUse hook captures this and writes to temp file.
# Dashboard reads /tmp/jat-signal-{session}.json via SSE.

set -euo pipefail

# Script directory for finding validation tool
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"

# Try to find validation script in multiple locations
find_validator() {
    local locations=(
        "/home/jw/code/jat/signal/jat-signal-validate"
        "${SCRIPT_DIR}/jat-signal-validate"
    )
    for loc in "${locations[@]}"; do
        if [[ -x "$loc" ]]; then
            echo "$loc"
            return 0
        fi
    done
    return 1
}

show_usage() {
    echo "Usage: jat-signal <signal> <json-payload> [--no-validate] [--strict]"
    echo ""
    echo "State Signals (require JSON payload):"
    echo "  working '{...}'       - Working on task"
    echo "  review '{...}'        - Ready for human review"
    echo "  needs_input '{...}'   - Waiting for user input"
    echo "  idle '{...}'          - Session idle"
    echo "  completing '{...}'    - Running completion steps"
    echo "  completed '{...}'     - Task completed"
    echo "  starting '{...}'      - Session initializing"
    echo "  compacting '{...}'    - Summarizing context"
    echo "  auto_proceed '{...}'  - OK to auto-close"
    echo ""
    echo "Data Signals (always JSON):"
    echo "  tasks '[{...}]'       - Suggest follow-up tasks"
    echo "  action '{...}'        - Request human action"
    echo "  complete '{...}'      - Full completion bundle"
    echo ""
    echo "Options:"
    echo "  --no-validate         Skip schema validation"
    echo "  --strict              Fail on validation errors (default: warn)"
    echo ""
    echo "Examples:"
    echo "  jat-signal working '{\"taskId\":\"jat-abc\",\"taskTitle\":\"Add auth\"}'"
    echo "  jat-signal review '{\"taskId\":\"jat-abc\",\"summary\":[\"Added login\"]}'"
    echo "  jat-signal needs_input '{\"taskId\":\"jat-abc\",\"question\":\"Which lib?\",\"questionType\":\"choice\"}'"
    echo "  jat-signal idle '{\"readyForWork\":true}'"
    echo "  jat-signal completed '{\"taskId\":\"jat-abc\",\"outcome\":\"success\"}'"
    echo ""
    echo "Required Fields by Signal Type:"
    echo "  working:     taskId, taskTitle"
    echo "  review:      taskId"
    echo "  needs_input: taskId, question, questionType"
    echo "  idle:        readyForWork"
    echo "  completing:  taskId, currentStep"
    echo "  completed:   taskId, outcome"
    echo "  starting:    agentName"
    echo "  compacting:  reason, contextSizeBefore"
    echo "  auto_proceed: taskId"
}

# Parse options
VALIDATE=true
STRICT=false
POSITIONAL_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --no-validate)
            VALIDATE=false
            shift
            ;;
        --strict)
            STRICT=true
            shift
            ;;
        -h|--help|help)
            show_usage
            exit 0
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

set -- "${POSITIONAL_ARGS[@]:-}"

SIGNAL_TYPE="${1:-}"
SIGNAL_DATA="${2:-}"

# Validate signal payload
validate_payload() {
    local signal_type="$1"
    local payload="$2"

    if [[ "$VALIDATE" != "true" ]]; then
        return 0
    fi

    local validator
    if ! validator=$(find_validator); then
        echo "Warning: jat-signal-validate not found, skipping validation" >&2
        return 0
    fi

    local validation_output
    local validation_exit=0

    validation_output=$("$validator" "$signal_type" "$payload" 2>&1) || validation_exit=$?

    if [[ $validation_exit -ne 0 ]]; then
        if [[ "$STRICT" == "true" ]]; then
            echo "Error: Validation failed: $validation_output" >&2
            exit 1
        else
            echo "Warning: $validation_output" >&2
        fi
    fi

    return 0
}

# Require JSON payload for state signals
require_json() {
    local signal_type="$1"
    local data="$2"

    if [[ -z "$data" ]]; then
        echo "Error: $signal_type requires JSON payload"
        echo "Example: jat-signal $signal_type '{\"taskId\":\"...\"}'"
        exit 1
    fi

    if ! echo "$data" | jq . >/dev/null 2>&1; then
        echo "Error: Invalid JSON for $signal_type signal"
        exit 1
    fi
}

if [[ -z "$SIGNAL_TYPE" ]]; then
    show_usage
    exit 1
fi

case "$SIGNAL_TYPE" in
    working)
        require_json "working" "$SIGNAL_DATA"
        validate_payload "working" "$SIGNAL_DATA"
        TASK_ID=$(echo "$SIGNAL_DATA" | jq -r '.taskId // ""')
        TASK_TITLE=$(echo "$SIGNAL_DATA" | jq -r '.taskTitle // ""')
        echo "Signal: working (task: ${TASK_ID} - ${TASK_TITLE})"
        echo "[JAT-SIGNAL:working] $SIGNAL_DATA"
        ;;

    review|needs_review)
        require_json "review" "$SIGNAL_DATA"
        validate_payload "review" "$SIGNAL_DATA"
        TASK_ID=$(echo "$SIGNAL_DATA" | jq -r '.taskId // ""')
        SUMMARY_COUNT=$(echo "$SIGNAL_DATA" | jq '.summary // [] | length')
        echo "Signal: review (task: ${TASK_ID}, ${SUMMARY_COUNT} items)"
        echo "[JAT-SIGNAL:review] $SIGNAL_DATA"
        ;;

    needs_input|input)
        require_json "needs_input" "$SIGNAL_DATA"
        validate_payload "needs_input" "$SIGNAL_DATA"
        TASK_ID=$(echo "$SIGNAL_DATA" | jq -r '.taskId // ""')
        QUESTION_TYPE=$(echo "$SIGNAL_DATA" | jq -r '.questionType // "text"')
        echo "Signal: needs_input (task: ${TASK_ID}, type: ${QUESTION_TYPE})"
        echo "[JAT-SIGNAL:needs_input] $SIGNAL_DATA"
        ;;

    idle)
        require_json "idle" "$SIGNAL_DATA"
        validate_payload "idle" "$SIGNAL_DATA"
        READY=$(echo "$SIGNAL_DATA" | jq -r '.readyForWork // true')
        TASKS_COMPLETED=$(echo "$SIGNAL_DATA" | jq -r '.sessionSummary.tasksCompleted // [] | length')
        SUGGESTED=$(echo "$SIGNAL_DATA" | jq -r '.suggestedNextTask.taskId // ""')
        BLOCKED=$(echo "$SIGNAL_DATA" | jq -r '.blockedReason // ""')
        if [[ -n "$BLOCKED" ]]; then
            echo "Signal: idle (ready: ${READY}, blocked: ${BLOCKED})"
        elif [[ "$TASKS_COMPLETED" -gt 0 ]] && [[ -n "$SUGGESTED" ]]; then
            echo "Signal: idle (ready: ${READY}, completed: ${TASKS_COMPLETED}, next: ${SUGGESTED})"
        elif [[ "$TASKS_COMPLETED" -gt 0 ]]; then
            echo "Signal: idle (ready: ${READY}, completed: ${TASKS_COMPLETED} tasks)"
        elif [[ -n "$SUGGESTED" ]]; then
            echo "Signal: idle (ready: ${READY}, next: ${SUGGESTED})"
        else
            echo "Signal: idle (ready: ${READY})"
        fi
        echo "[JAT-SIGNAL:idle] $SIGNAL_DATA"
        ;;

    completing)
        require_json "completing" "$SIGNAL_DATA"
        validate_payload "completing" "$SIGNAL_DATA"
        TASK_ID=$(echo "$SIGNAL_DATA" | jq -r '.taskId // ""')
        STEP=$(echo "$SIGNAL_DATA" | jq -r '.currentStep // ""')
        echo "Signal: completing (task: ${TASK_ID}, step: ${STEP})"
        echo "[JAT-SIGNAL:completing] $SIGNAL_DATA"
        ;;

    completed|done)
        require_json "completed" "$SIGNAL_DATA"
        validate_payload "completed" "$SIGNAL_DATA"
        TASK_ID=$(echo "$SIGNAL_DATA" | jq -r '.taskId // ""')
        OUTCOME=$(echo "$SIGNAL_DATA" | jq -r '.outcome // ""')
        echo "Signal: completed (task: ${TASK_ID}, outcome: ${OUTCOME})"
        echo "[JAT-SIGNAL:completed] $SIGNAL_DATA"
        ;;

    starting)
        require_json "starting" "$SIGNAL_DATA"
        validate_payload "starting" "$SIGNAL_DATA"
        AGENT_NAME=$(echo "$SIGNAL_DATA" | jq -r '.agentName // ""')
        PROJECT=$(echo "$SIGNAL_DATA" | jq -r '.project // ""')
        echo "Signal: starting (agent: ${AGENT_NAME}, project: ${PROJECT})"
        echo "[JAT-SIGNAL:starting] $SIGNAL_DATA"
        ;;

    compacting)
        require_json "compacting" "$SIGNAL_DATA"
        validate_payload "compacting" "$SIGNAL_DATA"
        REASON=$(echo "$SIGNAL_DATA" | jq -r '.reason // ""')
        CONTEXT_BEFORE=$(echo "$SIGNAL_DATA" | jq -r '.contextSizeBefore // 0')
        echo "Signal: compacting (reason: ${REASON}, context: ${CONTEXT_BEFORE})"
        echo "[JAT-SIGNAL:compacting] $SIGNAL_DATA"
        ;;

    auto_proceed|auto-proceed)
        require_json "auto_proceed" "$SIGNAL_DATA"
        validate_payload "auto_proceed" "$SIGNAL_DATA"
        TASK_ID=$(echo "$SIGNAL_DATA" | jq -r '.taskId // ""')
        NEXT_TASK=$(echo "$SIGNAL_DATA" | jq -r '.nextTaskId // ""')
        if [[ -n "$NEXT_TASK" ]]; then
            echo "Signal: auto_proceed (task: ${TASK_ID}, next: ${NEXT_TASK})"
        else
            echo "Signal: auto_proceed (task: ${TASK_ID})"
        fi
        echo "[JAT-SIGNAL:auto_proceed] $SIGNAL_DATA"
        ;;

    # Data signals
    tasks)
        require_json "tasks" "$SIGNAL_DATA"
        validate_payload "tasks" "$SIGNAL_DATA"
        TASK_COUNT=$(echo "$SIGNAL_DATA" | jq 'length')
        echo "Signal: tasks (${TASK_COUNT} suggested)"
        echo "[JAT-SIGNAL:tasks] $SIGNAL_DATA"
        ;;

    action)
        require_json "action" "$SIGNAL_DATA"
        validate_payload "action" "$SIGNAL_DATA"
        ACTION_TITLE=$(echo "$SIGNAL_DATA" | jq -r '.title // "untitled"')
        echo "Signal: action (${ACTION_TITLE})"
        echo "[JAT-SIGNAL:action] $SIGNAL_DATA"
        ;;

    complete)
        if [[ -n "$SIGNAL_DATA" ]]; then
            if ! echo "$SIGNAL_DATA" | jq . >/dev/null 2>&1; then
                echo "Error: Invalid JSON for complete signal"
                exit 1
            fi
            validate_payload "complete" "$SIGNAL_DATA"
            TASK_COUNT=$(echo "$SIGNAL_DATA" | jq '.suggestedTasks // [] | length')
            ACTION_COUNT=$(echo "$SIGNAL_DATA" | jq '.humanActions // [] | length')
            echo "Signal: complete (${TASK_COUNT} tasks, ${ACTION_COUNT} actions)"
        else
            SIGNAL_DATA="{}"
            echo "Signal: complete"
        fi
        echo "[JAT-SIGNAL:complete] $SIGNAL_DATA"
        ;;

    -h|--help|help)
        show_usage
        exit 0
        ;;

    *)
        echo "Error: Unknown signal type '$SIGNAL_TYPE'"
        show_usage
        exit 1
        ;;
esac

exit 0
