#!/bin/bash
# bd-dashboard - Launch the Beads Task Dashboard
# Part of jomarchy-agent-tools
#
# Usage:
#   bd-dashboard           # Start in tmux (default), detached
#   bd-dashboard --attach  # Start in tmux and attach
#   bd-dashboard -f        # Run in foreground (old behavior)

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m' # No Color

SESSION_NAME="jat-dashboard"

# Parse arguments
FOREGROUND=false
ATTACH=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--foreground)
            FOREGROUND=true
            shift
            ;;
        -a|--attach)
            ATTACH=true
            shift
            ;;
        *)
            shift
            ;;
    esac
done

# Get the directory where this script is located (resolve symlinks)
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SCRIPT_SOURCE" ]; do
    SCRIPT_DIR="$( cd -P "$( dirname "$SCRIPT_SOURCE" )" && pwd )"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$SCRIPT_DIR/$SCRIPT_SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SCRIPT_SOURCE" )" && pwd )"
DASHBOARD_DIR="$SCRIPT_DIR/dashboard"

# Get port from JAT config
CONFIG_FILE="$HOME/.config/jat/projects.json"
if [ -f "$CONFIG_FILE" ]; then
    PORT=$(jq -r '.projects.jat.port // 5173' "$CONFIG_FILE")
else
    PORT=5173
fi

echo -e "${GREEN}ðŸš€ Beads Task Dashboard Launcher${NC}"
echo ""

# Check if dashboard directory exists
if [ ! -d "$DASHBOARD_DIR" ]; then
    echo -e "${RED}âŒ Error: Dashboard directory not found at $DASHBOARD_DIR${NC}"
    exit 1
fi

cd "$DASHBOARD_DIR"

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}ðŸ“¦ node_modules not found. Running npm install...${NC}"
    npm install
    echo -e "${GREEN}âœ… Dependencies installed${NC}"
    echo ""
fi

# Check if package.json exists
if [ ! -f "package.json" ]; then
    echo -e "${RED}âŒ Error: package.json not found${NC}"
    exit 1
fi

# Function to open browser
open_browser() {
    local url="http://127.0.0.1:$PORT"
    sleep 2  # Give server time to start

    if command -v xdg-open > /dev/null; then
        xdg-open "$url" 2>/dev/null || true
    elif command -v open > /dev/null; then
        open "$url" 2>/dev/null || true
    fi
}

# Foreground mode (old behavior)
if [ "$FOREGROUND" = true ]; then
    echo -e "${GREEN}ðŸ”§ Starting development server in foreground on port $PORT...${NC}"
    echo ""
    npm run dev -- --port "$PORT"
    exit 0
fi

# Tmux mode (default)
# Check if session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo -e "${CYAN}âœ“ Dashboard already running in tmux session: $SESSION_NAME${NC}"
    echo ""

    # Check if port is listening
    if ss -tlnp 2>/dev/null | grep -q ":$PORT "; then
        echo -e "${GREEN}âœ“ Server is running on port $PORT${NC}"
        echo -e "  URL: ${CYAN}http://127.0.0.1:$PORT${NC}"
    else
        echo -e "${YELLOW}âš  Session exists but port $PORT not listening${NC}"
    fi
    echo ""
    echo -e "Commands:"
    echo -e "  ${CYAN}tmux attach -t $SESSION_NAME${NC}  - Attach to session"
    echo -e "  ${CYAN}tmux kill-session -t $SESSION_NAME${NC}  - Stop dashboard"
    echo ""

    if [ "$ATTACH" = true ]; then
        echo -e "${GREEN}Attaching to session...${NC}"
        tmux attach -t "$SESSION_NAME"
    fi
    exit 0
fi

echo -e "${GREEN}ðŸ”§ Starting development server in tmux on port $PORT...${NC}"
echo ""

# Create tmux session with the dashboard
tmux new-session -d -s "$SESSION_NAME" -c "$DASHBOARD_DIR" "npm run dev -- --port $PORT; exec bash"

# Wait for server to start and open browser
open_browser &

echo -e "${GREEN}âœ“ Dashboard started in tmux session: $SESSION_NAME${NC}"
echo -e "  URL: ${CYAN}http://127.0.0.1:$PORT${NC}"
echo ""
echo -e "Commands:"
echo -e "  ${CYAN}tmux attach -t $SESSION_NAME${NC}  - Attach to session"
echo -e "  ${CYAN}tmux kill-session -t $SESSION_NAME${NC}  - Stop dashboard"
echo ""

if [ "$ATTACH" = true ]; then
    echo -e "${GREEN}Attaching to session...${NC}"
    sleep 1
    tmux attach -t "$SESSION_NAME"
fi
