#!/bin/bash
#
# Calculate human-readable time difference from a UTC timestamp
#
# Usage: time-ago "2025-11-21 01:36:43"
# Output: "5 minutes ago" or "2 hours ago" or "3 days ago"
#
# Input: SQLite datetime format (UTC): "YYYY-MM-DD HH:MM:SS"
# Converts UTC to local time before calculating difference

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: time-ago 'YYYY-MM-DD HH:MM:SS'" >&2
    exit 1
fi

UTC_TIMESTAMP="$1"

# Convert SQLite UTC timestamp to epoch (seconds since 1970)
# date -d handles UTC conversion automatically
TIMESTAMP_EPOCH=$(date -d "${UTC_TIMESTAMP} UTC" +%s 2>/dev/null || echo "0")

if [[ $TIMESTAMP_EPOCH -eq 0 ]]; then
    echo "unknown"
    exit 0
fi

# Get current time in epoch
NOW_EPOCH=$(date +%s)

# Calculate difference in seconds
DIFF_SECONDS=$((NOW_EPOCH - TIMESTAMP_EPOCH))

# Handle negative differences (future timestamps)
if [[ $DIFF_SECONDS -lt 0 ]]; then
    echo "just now"
    exit 0
fi

# Convert to human-readable format
if [[ $DIFF_SECONDS -lt 60 ]]; then
    echo "just now"
elif [[ $DIFF_SECONDS -lt 3600 ]]; then
    MINUTES=$((DIFF_SECONDS / 60))
    if [[ $MINUTES -eq 1 ]]; then
        echo "1 minute ago"
    else
        echo "${MINUTES} minutes ago"
    fi
elif [[ $DIFF_SECONDS -lt 86400 ]]; then
    HOURS=$((DIFF_SECONDS / 3600))
    if [[ $HOURS -eq 1 ]]; then
        echo "1 hour ago"
    else
        echo "${HOURS} hours ago"
    fi
else
    DAYS=$((DIFF_SECONDS / 86400))
    if [[ $DAYS -eq 1 ]]; then
        echo "1 day ago"
    else
        echo "${DAYS} days ago"
    fi
fi
