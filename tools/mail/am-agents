#!/usr/bin/env bash
# List all agents in a project
# Usage: am-agents [--json]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/am-lib.sh"

# Parse arguments
PROJECT="$PROJECT_KEY"
JSON_OUTPUT=false

show_help() {
    cat <<EOF
Usage: am-agents [options]

List all agents registered in a project.

Options:
  --project PATH      Project path (default: current directory)
  --json              Output as JSON
  --help, -h          Show this help

Examples:
  am-agents
  am-agents --json
  am-agents --project /path/to/repo

Database: $AGENT_MAIL_DB
EOF
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        --project)
            PROJECT="$2"
            shift 2
            ;;
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            am_error "Unknown option: $1"
            ;;
    esac
done

# Get or create project
PROJECT_ID=$(am_get_project "$AGENT_MAIL_DB" "$PROJECT")

# Fetch all agents
AGENTS=$(sqlite3 -json "$AGENT_MAIL_DB" <<SQL
SELECT
    name,
    program,
    model,
    task_description,
    inception_ts,
    last_active_ts
FROM agents
WHERE project_id = $PROJECT_ID
ORDER BY last_active_ts DESC;
SQL
)

# Add human-readable "last_active_ago" field (handles UTCâ†’local conversion)
ENHANCED_AGENTS="[]"
AGENT_COUNT=$(echo "$AGENTS" | jq '. | length')

for ((i=0; i<AGENT_COUNT; i++)); do
    AGENT=$(echo "$AGENTS" | jq -r ".[$i]")
    LAST_ACTIVE_TS=$(echo "$AGENT" | jq -r '.last_active_ts // ""')

    if [[ -n "$LAST_ACTIVE_TS" ]]; then
        LAST_ACTIVE_AGO=$(~/code/jat/scripts/time-ago "$LAST_ACTIVE_TS" 2>/dev/null || echo "unknown")
    else
        LAST_ACTIVE_AGO="never"
    fi

    ENHANCED_AGENT=$(echo "$AGENT" | jq --arg ago "$LAST_ACTIVE_AGO" '. + {last_active_ago: $ago}')
    ENHANCED_AGENTS=$(echo "$ENHANCED_AGENTS" | jq ". += [$ENHANCED_AGENT]")
done

AGENTS="$ENHANCED_AGENTS"

# Display agents
if [[ "$JSON_OUTPUT" == "true" ]]; then
    echo "$AGENTS" | am_format_json
else
    AGENT_COUNT=$(echo "$AGENTS" | jq '. | length')

    if [[ "$AGENT_COUNT" == "0" ]]; then
        echo "No agents registered in this project"
        echo "Run: am-register --name AgentName"
        exit 0
    fi

    echo "Agents in project ($AGENT_COUNT):"
    echo ""

    echo "$AGENTS" | jq -r '.[] | "  \(.name)
    Program: \(.program)
    Model: \(.model)
    Task: \(.task_description // "(none)")
    Last active: \(.last_active_ago) (\(.last_active_ts))
"'
fi
